<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Profile - Greia</title>
<link rel="icon" type="image/png" href="../assets/greia (4).png"/>
<link href="../css/profile.css" rel="stylesheet"/>
<link href="../css/profile-nav.css" rel="stylesheet"/>
<link href="../css/main.css" rel="stylesheet"/>
<link href="../css/global-nav.css" rel="stylesheet"/>
<link href="../css/footer.css" rel="stylesheet"/>
<script src="../scripts/main.js"></script>
<style>
/* Navigation Bar */
.navbar {
  background: linear-gradient(90deg, #1c0bff, #00c6d4, #1c0bff);
  background-size: 200% 100%;
  padding: 0 2rem;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  box-shadow: 0 8px 20px rgba(28,11,255,0.15);
  margin: 0;
  animation: gradientFlow 15s linear infinite;
}
.nav-link {
  position: relative;
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  padding: 14px 32px;
  font-size: 1.08em;
  color: #222;
  border-radius: 6px;
  transition: all 0.2s ease-out;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  letter-spacing: 0.01em;
  overflow: hidden;
}

.nav-link::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 4px;
  background: #1c0bff;
  transform: scaleY(0);
  transition: transform 0.2s ease-out;
}

.nav-link:hover {
  background: rgba(28,11,255,0.05);
}

.nav-link:hover::before,
.nav-link.active::before {
  transform: scaleY(1);
}

.nav-link.active {
  color: #1c0bff;
  background: rgba(28,11,255,0.08);
}

/* Section Transitions */
.profile-section {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  display: none;
}

.profile-section.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* Layout */
.profile-flex-layout {
  display: flex;
  align-items: flex-start;
  width: 100%;
  max-width: 1400px;
  margin: 0 auto;
  min-height: 80vh;
}

/* Profile Content Card */
.profile-content-card {
  flex: 1;
  background: #fff;
  border-radius: 0 18px 18px 0;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
  padding: 40px 32px;
  min-height: 80vh;
}

/* Feature Box Grid */
.feature-box-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 32px;
}

.feature-box {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.feature-box h3 {
  margin: 0 0 8px;
  color: #1c0bff;
  font-size: 16px;
}

.feature-box .value {
  font-size: 24px;
  font-weight: 600;
}

.feature-box .label {
  color: #666;
  font-size: 14px;
  margin-top: 4px;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .navbar-thirds {
    flex-direction: column;
    gap: 1rem;
  }
  
  .nav-links {
    flex-direction: column;
    gap: 1rem;
  }
  
  .profile-flex-layout {
    flex-direction: column;
  }
  
  .profile-sidebar {
    width: 100%;
    min-width: unset;
    border-radius: 18px 18px 0 0;
    padding: 16px 0;
  }
  
  .sidebar-nav {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    padding: 0 16px;
  }
  
  .nav-link {
    padding: 10px 16px;
  }
  
  .profile-content-card {
    border-radius: 0 0 18px 18px;
    padding: 24px 16px;
  }
  
  .feature-box-grid {
    grid-template-columns: 1fr;
  }
}
.profile-sidebar {
  padding: 32px 0 32px 0;
  width: 240px;
  margin-right: 36px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  gap: 8px;
  position: sticky;
  top: 0;
  backdrop-filter: blur(8px);
  border-right: 1.5px solid #e0e7ef;
}

.profile-sidebar .sidebar-nav button {
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  padding: 14px 32px;
  font-size: 1.08em;
  color: #222;
  border-radius: 0;
  transition: background 0.15s, color 0.15s;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  letter-spacing: 0.01em;
}

.profile-sidebar .sidebar-nav button.active,
.profile-sidebar .sidebar-nav button:hover {
  background: rgba(28,11,255,0.08);
  color: #1c0bff;
}

/* Special styling for admin dashboard button */
.profile-sidebar .sidebar-nav button#nav-admin-dashboard {
  background: linear-gradient(135deg, #1c0bff 0%, #4c1bff 100%);
  color: white;
  font-weight: 600;
  margin: 8px 0;
  border-radius: 8px;
}

.profile-sidebar .sidebar-nav button#nav-admin-dashboard:hover {
  background: linear-gradient(135deg, #1a0ae6 0%, #461ae6 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(28,11,255,0.3);
}

/* Glassy card for profile content */
.profile-content-card {
  background: rgba(255,255,255,0.92);
  border-radius: 22px;
  box-shadow: 0 4px 32px rgba(28,11,255,0.10);
  padding: 40px 36px 36px 36px;
  min-width: 340px;
  max-width: 700px;
  width: 100%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  backdrop-filter: blur(8px);
  border: 1.5px solid #e0e7ef;
}

/* Edit Profile Modal Styles */
#edit-profile-modal {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#edit-profile-modal input:focus,
#edit-profile-modal textarea:focus,
#edit-profile-modal select:focus {
  outline: none;
  border-color: #1c0bff;
  box-shadow: 0 0 0 3px rgba(28,11,255,0.1);
}

#edit-profile-modal label[onclick^="handleRoleChange"] {
  transition: all 0.2s ease;
}

#edit-profile-modal label[onclick^="handleRoleChange"]:hover {
  border-color: #1c0bff !important;
  background: rgba(28,11,255,0.02) !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(28,11,255,0.1);
}

#edit-profile-modal button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

#edit-profile-modal .modal-content {
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* File input styling */
#edit-profile-modal input[type="file"] {
  background: #f8fafc;
  cursor: pointer;
}

#edit-profile-modal input[type="file"]:hover {
  background: #f1f5f9;
}

/* Responsive modal */
@media (max-width: 768px) {
  #edit-profile-modal > div {
    margin: 20px;
    max-width: none;
  }
  
  #edit-profile-modal .grid-2 {
    grid-template-columns: 1fr !important;
  }
}

/* PSRA Verification Styles */
#verify-psra-btn:hover {
  background: #047857 !important;
}

.psra-verification-result {
  margin-top: 10px;
  padding: 15px;
  border-radius: 8px;
  font-size: 14px;
}

.psra-verified {
  background: #dcfce7;
  color: #16a34a;
  border: 1px solid #bbf7d0;
}

.psra-not-found {
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fecaca;
}

.psra-error {
  background: #fef3c7;
  color: #d97706;
  border: 1px solid #fed7aa;
}

.psra-loading {
  background: #f1f5f9;
  color: #475569;
  border: 1px solid #e2e8f0;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 32px;
  margin-bottom: 36px;
  border-bottom: 1px solid #f0f0f0;
  padding-bottom: 24px;
}

.profile-header .profile-picture {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 2px 12px rgba(28,11,255,0.08);
  border: 4px solid #e9ecef;
  background: #f4f4f4;
}

.profile-header .profile-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.profile-header .profile-fullname {
  font-size: 2.1em;
  font-weight: 700;
  color: #222;
  margin-bottom: 2px;
  letter-spacing: 0.01em;
}

.profile-header .profile-company {
  font-size: 1.1em;
  color: #1c0bff;
  font-weight: 500;
}

.profile-header .profile-profession {
  font-size: 1em;
  color: #555;
  font-style: italic;
}

.profile-header .profile-email,
.profile-header .profile-phone {
  font-size: 1em;
  color: #888;
}

/* Hide all profile sections by default except .profile-section.active */
.profile-section {
  display: none;
}

.profile-section.active {
  display: block;
}

/* Style for forms and buttons */
.profile-content-card form label {
  display: block;
  margin-bottom: 12px;
  font-size: 1.08em;
  color: #222;
}

.profile-content-card form input,
.profile-content-card form select,
.profile-content-card form textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1em;
  margin-top: 4px;
  margin-bottom: 8px;
  background: #f8fafc;
  transition: border 0.18s;
  box-sizing: border-box;
}

.profile-content-card form input:focus,
.profile-content-card form select:focus,
.profile-content-card form textarea:focus {
  border-color: #1c0bff;
  background: #fff;
}

.profile-content-card button,
.profile-content-card input[type="submit"] {
  background: #1c0bff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 28px;
  font-size: 1.08em;
  font-weight: 500;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.18s;
}

.profile-content-card button:hover,
.profile-content-card input[type="submit"]:hover {
  background: #0a0b3c;
}

/* Card grid for listings/ads/services */
.profile-card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 24px;
  margin-top: 18px;
}

.profile-card {
  background: #f8fafc;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(28,11,255,0.06);
  padding: 18px 14px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  min-height: 180px;
  position: relative;
}

.profile-card-img, .property-card-img {
  width: 100%;
  max-width: 120px;
  height: 80px;
  object-fit: cover;
  border-radius: 10px;
  margin-bottom: 10px;
  background: #e9ecef;
}

.profile-card-title, .property-card-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #1c0bff;
  margin-bottom: 2px;
}

.profile-card-detail, .property-card-address, .property-card-price, .property-card-type {
  font-size: 0.98em;
  color: #555;
  margin-bottom: 2px;
}

.profile-card-actions {
  margin-top: 10px;
  display: flex;
  gap: 8px;
}

.profile-card-btn {
  background: #fff;
  color: #1c0bff;
  border: 1px solid #1c0bff;
  border-radius: 6px;
  padding: 6px 14px;
  font-size: 0.98em;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  text-decoration: none;
}

.profile-card-btn:hover {
  background: #1c0bff;
  color: #fff;
}

/* Minimal Exposure Packages Styling */
.exposure-tier-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(28,11,255,0.07);
  padding: 22px 18px;
  min-width: 200px;
  max-width: 280px;
  text-align: center;
  border: 1px solid #f0f0f0;
  margin-bottom: 12px;
  transition: box-shadow 0.18s, border 0.18s;
}
.exposure-tier-card:hover {
  box-shadow: 0 4px 16px rgba(28,11,255,0.13);
  border-color: #dbeafe;
}
.exposure-tier-card h3 {
  font-size: 1.18em;
  font-weight: 600;
  color: #1c0bff;
  margin-bottom: 6px;
}
.exposure-tier-card p {
  font-size: 0.98em;
  color: #555;
  margin-bottom: 0;
}
.exposure-tier-card .profile-card-btn {
  margin-top: 14px;
  background: #f8fafc;
  color: #1c0bff;
  border: 1px solid #e0e7ef;
  border-radius: 6px;
  padding: 7px 16px;
  font-size: 0.97em;
  font-weight: 500;
  transition: background 0.15s, color 0.15s, border 0.15s;
}
.exposure-tier-card .profile-card-btn:hover {
  background: #1c0bff;
  color: #fff;
  border-color: #1c0bff;
}

.delete-account-btn {
  margin: 32px auto 0 auto;
  background: #fff;
  color: #c00;
  border: 1.5px solid #c00;
  border-radius: 8px;
  padding: 12px 32px;
  font-size: 1.1em;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.18s, color 0.18s, border 0.18s;
  display: block;
}

.delete-account-btn:hover {
  background: #c00;
  color: #fff;
  border-color: #a00;
}

@media (max-width: 900px) {
  .profile-main-wrapper {
    flex-direction: column;
    align-items: center;
    padding: 0;
  }
  
  .profile-sidebar {
    flex-direction: row;
    width: 98vw;
    margin: 0 0 24px 0;
    min-height: unset;
    padding: 18px 0;
    justify-content: center;
    gap: 0;
    border-radius: 0;
    border-right: none;
    border-bottom: 1.5px solid #e0e7ef;
  }
  
  .profile-content-card {
    padding: 18px 6vw 18px 6vw;
    min-width: 0;
    max-width: 99vw;
  }
}

/* Auto-save indicators */
.save-indicator {
  font-size: 12px;
  font-weight: 500;
  margin-left: 8px;
  padding: 2px 6px;
  border-radius: 4px;
  transition: all 0.3s ease;
}

.save-indicator.saving {
  color: #666;
  background: rgba(108, 117, 125, 0.1);
  animation: pulse 1.5s infinite;
}

.save-indicator.saved {
  color: #28a745;
  background: rgba(40, 167, 69, 0.1);
}

.save-indicator.error {
  color: #dc3545;
  background: rgba(220, 53, 69, 0.1);
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Enhanced form field styling for auto-save */
.profile-content-card form label {
  position: relative;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.profile-content-card form input:focus,
.profile-content-card form select:focus,
.profile-content-card form textarea:focus {
  border-color: #1c0bff;
  background: #fff;
  box-shadow: 0 0 0 2px rgba(28, 11, 255, 0.1);
}

/* Auto-save enabled fields get a subtle indicator */
.profile-content-card form input.auto-save-enabled,
.profile-content-card form select.auto-save-enabled,
.profile-content-card form textarea.auto-save-enabled {
  border-left: 3px solid #e9ecef;
  transition: border-left 0.3s ease;
}

.profile-content-card form input.auto-save-enabled:focus,
.profile-content-card form select.auto-save-enabled:focus,
.profile-content-card form textarea.auto-save-enabled:focus {
  border-left: 3px solid #1c0bff;
}
</style>
</head>
<body>
<nav class="profile-nav" style="display:flex;gap:18px;justify-content:center;margin:32px 0 18px 0;">

  <!-- Add more buttons for other sections as needed -->
</nav>
<div id="profile-section-container" style="max-width:900px;margin:0 auto;"></div>
<!-- Full Screen Greia Pro Membership Modal (ALWAYS ABOVE ALL CONTENT) -->
<div id="pro-signup-modal" style="display:none; position:fixed; z-index:10000; top:0; left:0; width:100vw; height:100vh; background:#fff; color:#222; overflow:auto;">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;width:100vw;background:#fff;position:relative;">
    <button onclick="closeMembershipModal()" style="position:absolute; top:24px; right:32px; background:none; border:none; font-size:32px; color:#888; cursor:pointer;">&times;</button>
    <h2 style="margin:0 0 18px 0; text-align:center; font-size:2.2em; font-weight:700; color:#635bff;">Greia Pro Membership</h2>
    <div style="font-size:2em; font-weight:600; color:#635bff; margin-bottom:12px;">‚Ç¨29 / month</div>
    <div style="font-size:1.1em; color:#444; margin-bottom:32px; text-align:center; max-width:340px;">Unlock all Pro features and save 50% on exposure packages!</div>
    <button id="pro-stripe-btn" type="button" style="background:#635bff; color:#fff; border:none; padding:18px 48px; border-radius:10px; font-size:1.2em; cursor:pointer; margin-bottom:12px;">Pay with Stripe</button>
  </div>
</div>

<!-- Full Screen Exposure Package Modal (ALWAYS ABOVE ALL CONTENT) -->
<div id="exposure-modal" style="display:none; position:fixed; z-index:10000; top:0; left:0; width:100vw; height:100vh; background:#fff; color:#222; overflow:auto;">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;width:100vw;background:#fff;position:relative;">
    <button onclick="closeExposureModal()" style="position:absolute; top:24px; right:32px; background:none; border:none; font-size:32px; color:#888; cursor:pointer;">&times;</button>
    <h2 style="margin:0 0 18px 0; text-align:center; font-size:2.2em; font-weight:700; color:#635bff;">Purchase Exposure Package</h2>
    <div id="exposure-modal-content" style="margin-bottom:24px; text-align:center; font-size:1.1em; color:#444; max-width:340px;">
      <!-- Details will be injected here -->
    </div>
    <form id="exposure-purchase-form" style="margin-top:24px; display:flex; flex-direction:column; align-items:center; gap:18px; width:100%; max-width:340px;">
      <label for="exposure-target-select" style="font-weight:500; margin-bottom:8px; display:block; text-align:left;">Select Property or Service to Promote:</label>
      <select id="exposure-target-select" name="target_id" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:18px;">
        <option value="">-- Select --</option>
        <!-- Options will be injected by JS -->
      </select>
      <button id="stripe-btn" type="button" style="background:#635bff; color:#fff; border:none; padding:18px 48px; border-radius:10px; font-size:1.2em; cursor:pointer;">Pay with Stripe</button>
      <button id="paypal-btn" type="button" style="background:#ffc439; color:#222; border:none; padding:18px 48px; border-radius:10px; font-size:1.2em; cursor:pointer;">Pay with PayPal</button>
      <button id="bank-btn" type="button" style="background:#e0e0e0; color:#222; border:none; padding:18px 48px; border-radius:10px; font-size:1.2em; cursor:pointer;">Bank Transfer</button>
    </form>
  </div>
</div>
<!-- Navigation Bar -->
<nav class="navbar">
  <div class="navbar-thirds">
    <div class="navbar-third left">
      <ul class="nav-links left-links" style="position:relative; z-index:100;">
        <li class="dropdown" style="position:relative;">
          <a href="/pages/buy.html" style="position:relative; z-index:101;">Property</a>
          <ul class="dropdown-menu" style="top:100%; left:0; margin-top:0; padding-top:0; border-top:0;">
            <li><a href="/pages/buy.html">Buy</a></li>
            <li><a href="/pages/rent.html">Rent</a></li>
            <li><a href="/pages/commercial.html">Commercial</a></li>
            <li><a href="/pages/buy.html">Apartments</a></li>
            <li><a href="/pages/sell.html">Sell</a></li>
            <li><a href="/pages/valuations.html">Valuations</a></li>
            <li><a href="/pages/buy.html">New Homes</a></li>
          </ul>
        </li>

        <li class="dropdown" style="position:relative;">
          <a href="/pages/agents.html" style="color: rgb(78, 255, 146); position:relative; z-index:101;" class="referral-dropdown-toggle">Connect</a>
          <ul class="dropdown-menu" style="top:100%; left:0; margin-top:0; padding-top:0; border-top:0;">
            <li><a href="/pages/agents.html">Find an Agent</a></li>
            <li class="nested-dropdown" style="position: relative;">
              <a href="/pages/agents.html" class="referral-dropdown-toggle" tabindex="0" aria-haspopup="true" aria-expanded="false">Referral Agents ‚ñ∏</a>
              <ul class="dropdown-menu referral-dropdown" style="display:none; position: absolute; left: 100%; top: 0; background: white; list-style:none; padding:10px; border:1px solid #ccc; min-width: 220px; z-index: 2000;">
                <li><a href="/pages/agents.html?subtype=luxury">Luxury Home Agents</a></li>
                <li><a href="/pages/agents.html?subtype=lettings">Lettings Agents</a></li>
                <li><a href="/pages/agents.html?subtype=newhomes">New Homes Agents</a></li>
                <li><a href="/pages/agents.html?subtype=commercial">Commercial Agents</a></li>
                <li><a href="/pages/agents.html?subtype=residential">Residential Agents</a></li>
                <li><a href="/pages/agents.html?subtype=developer">Developer Agents</a></li>
                <li><a href="/pages/agents.html?subtype=timeshare">Timeshare Agents</a></li>
              </ul>
            </li>
            <li><a href="/pages/coaching.html">Coaching</a></li>
          </ul>
        </li>

          <ul class="dropdown-menu" style="top:100%; left:0; margin-top:0; padding-top:0; border-top:0;">
            <li><a href="/pages/agents.html">Find an Agent</a></li>
            <li class="nested-dropdown" style="position: relative;">
              <a href="/pages/agents.html" class="referral-dropdown-toggle" tabindex="0" aria-haspopup="true" aria-expanded="false">Referral Agents ‚ñ∏</a>
              <ul class="dropdown-menu referral-dropdown" style="display:none; position: absolute; left: 100%; top: 0; background: white; list-style:none; padding:10px; border:1px solid #ccc; min-width: 220px; z-index: 2000;">
                <li><a href="/pages/agents.html?subtype=luxury">Luxury Home Agents</a></li>
                <li><a href="/pages/agents.html?subtype=lettings">Lettings Agents</a></li>
                <li><a href="/pages/agents.html?subtype=newhomes">New Homes Agents</a></li>
                <li><a href="/pages/agents.html?subtype=commercial">Commercial Agents</a></li>
                <li><a href="/pages/agents.html?subtype=residential">Residential Agents</a></li>
                <li><a href="/pages/agents.html?subtype=developer">Developer Agents</a></li>
                <li><a href="/pages/agents.html?subtype=timeshare">Timeshare Agents</a></li>
              </ul>
            </li>
            <li><a href="/pages/coaching.html">Coaching</a></li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="navbar-third center">
      <div class="logo">
        <a href="/index.html">
          <img alt="Logo" src="../assets/greia (4).png" style="height: auto; max-height: 140px;"/>
        </a>
      </div>
    </div>
    <div class="navbar-third right">
      <ul class="nav-links right-links">
        <li>
          <a href="/pages/services.html" class="fancy-underline">Our Services</a>
        </li>
        <li>
          <a href="/pages/concierge.html" class="fancy-underline">Concierge</a>
        </li>
        <li class="dropdown" id="auth-menu">
          <a href="/pages/login.html" id="login-btn">Log In</a>
          <ul class="dropdown-menu" id="login-dropdown">
            <li><a href="/pages/login.html">Sign In</a></li>
            <li><a href="/pages/register.html">Register</a></li>
            <li><a href="/pages/forgot-password.html">Forgot Password?</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
  <button aria-label="Toggle navigation" class="hamburger-menu">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <!-- Mobile nav menu -->
  <div class="mobile-nav-overlay"></div>
  <div class="mobile-nav">
    <ul>
      <li class="dropdown">
        <a href="/pages/buy.html" class="dropdown-toggle">Property</a>
        <ul class="dropdown-menu">
          <li><a href="/pages/buy.html">Buy</a></li>
          <li><a href="/pages/rent.html">Rent</a></li>
          <li><a href="/pages/commercial.html">Commercial</a></li>
          <li><a href="/pages/buy.html">Apartments</a></li>
          <li><a href="/pages/sell.html">Sell</a></li>
          <li><a href="/pages/valuations.html">Valuations</a></li>
          <li><a href="/pages/buy.html">New Homes</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="/pages/agents.html" class="dropdown-toggle" style="color: rgb(78, 255, 146);">Connect</a>
        <ul class="dropdown-menu">
          <li><a href="/pages/agents.html">Find an Agent</a></li>
          <li><a href="/pages/agents.html">Referral Agents</a></li>
          <li><a href="/pages/coaching.html">Coaching</a></li>
        </ul>
      </li>
      <li><a href="/pages/services.html">Our Services</a></li>
      <li><a href="/pages/concierge.html">Concierge</a></li>
      <li class="dropdown" id="mobile-auth-menu">
        <a href="/pages/login.html" class="dropdown-toggle" id="mobile-login-btn">Log In</a>
        <ul class="dropdown-menu" id="mobile-login-dropdown">
          <li><a href="/pages/login.html">Sign In</a></li>
          <li><a href="/pages/register.html">Register</a></li>
          <li><a href="/pages/forgot-password.html">Forgot Password?</a></li>
        </ul>
      </li>
    </ul>
  </div>
</nav>
<!-- Profile Photo Cropper Modal -->
<div id="profile-photo-cropper-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(30,16,80,0.92); color:#fff; overflow:auto; align-items:center; justify-content:center;">
  <div style="max-width:400px; margin:60px auto; background:#fff; color:#222; border-radius:18px; box-shadow:0 4px 32px #0004; padding:32px 24px; position:relative;">
    <h3 style="margin-top:0;">Crop Profile Photo</h3>
    <div id="cropper-container" style="width:100%; height:300px; background:#eee; margin-bottom:16px;"></div>
    <div style="display:flex; gap:12px; justify-content:flex-end;">
      <button id="cropper-save-btn" style="background:#1c0bff; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Save</button>
      <button id="cropper-cancel-btn" style="background:#ccc; color:#333; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
<script>
// Profile Photo Cropper Logic
let cropper;
const profilePicInput = document.getElementById('edit-profile-picture');
if (profilePicInput) {
  profilePicInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      document.getElementById('profile-photo-cropper-modal').style.display = 'flex';
      const container = document.getElementById('cropper-container');
      container.innerHTML = `<img id='cropper-img' src='${evt.target.result}' style='max-width:100%; max-height:100%;'/>`;
      const img = document.getElementById('cropper-img');
      cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(file);
  });
}
document.getElementById('cropper-cancel-btn').onclick = function() {
  document.getElementById('profile-photo-cropper-modal').style.display = 'none';
  if (cropper) cropper.destroy();
};
document.getElementById('cropper-save-btn').onclick = function() {
  if (!cropper) return;
  cropper.getCroppedCanvas().toBlob(function(blob) {
    // You can now upload 'blob' as the cropped image
    // For demo, just close modal
    document.getElementById('profile-photo-cropper-modal').style.display = 'none';
    cropper.destroy();
    // TODO: Implement upload logic here
  });
};

// Dashboard Cards Demo Data (replace with backend integration)
document.getElementById('dashboard-views-count').textContent = '123';
document.getElementById('dashboard-inquiries-count').textContent = '8';
document.getElementById('dashboard-bookings-count').textContent = '2';
/* Profile Page Alignment Improvements */
</script>
<style>
/* Mobile styles for side navigation */
@media (max-width: 600px) {
  .sidebar-nav {
    width: 100vw !important;
    min-width: unset !important;
    max-width: unset !important;
    position: fixed !important;
    left: 0;
    top: 0;
    height: 56px !important;
    background: #fff;
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    justify-content: space-around;
    z-index: 1000;
    border-bottom: 1px solid #eee;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 0 !important;
  }
  .sidebar-nav button {
    font-size: 0.95em !important;
    padding: 8px 10px !important;
    margin: 0 2px !important;
    min-width: 0 !important;
    border-radius: 6px !important;
  }
  .profile-section {
    margin-top: 60px !important;
    padding: 8px !important;
  }
  #section-exposure-packages h2 {
    font-size: 1.1em !important;
    margin-bottom: 10px !important;
  }
  #section-exposure-packages .profile-section > div,
  #section-exposure-packages .profile-section > form {
    font-size: 0.95em !important;
  }
  #exposure-package-form > div {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }
  #exposure-package-form label {
    min-width: 0 !important;
    height: 160px !important;
    padding: 12px !important;
    font-size: 0.95em !important;
  }
  #exposure-package-form label span,
  #exposure-package-form label div {
    font-size: 0.95em !important;
  }
  #exposure-package-form label span[style*="width:32px"] {
    width: 24px !important;
    height: 24px !important;
    margin-right: 7px !important;
  }
  #exposure-package-form label .package-feature {
    font-size: 0.9em !important;
    margin-bottom: 4px !important;
  }
  #exposure-package-form button {
    font-size: 1em !important;
    padding: 10px 16px !important;
  }
}
</style>
<style>
body {
  background: #f8fafc;
  font-family: 'Segoe UI', Arial, sans-serif;
}
.profile-content-card {
  max-width: 1200px;
  margin: 0 auto;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
  padding: 40px 32px 32px 32px;
  margin-top: 32px;
}
.profile-section {
  margin-bottom: 40px;
  padding: 24px 0;
  border-bottom: 1px solid #e2e8f0;
}
.profile-section:last-child {
  border-bottom: none;
}
.profile-card {
  background: #f8f8fa;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  padding: 24px;
  margin: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 220px;
  max-width: 320px;
}
.profile-card-img {
  border-radius: 12px;
  max-width: 120px;
  max-height: 120px;
  object-fit: cover;
  margin-bottom: 12px;
}
.profile-card-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #222;
  margin-bottom: 6px;
  text-align: center;
}
.profile-card-detail {
  font-size: 1rem;
  color: #555;
  margin-bottom: 4px;
  text-align: center;
}
.profile-card-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  justify-content: center;
}
.profile-card-btn {
  background: #1c0bff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 0.98rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.18s;
}
.profile-card-btn:hover {
  background: #0a0b3c;
}
.profile-section h2 {
  font-size: 1.6rem;
  font-weight: 700;
  color: #1c0bff;
  margin-bottom: 18px;
  text-align: left;
}
#user-listings-grid, #user-advertisements-grid, #user-services-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 24px;
  justify-items: center;
  align-items: stretch;
  margin-bottom: 24px;
}
#exposure-package-form {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  padding: 24px;
  margin-top: 18px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}
#exposure-package-form label {
  font-weight: 500;
  color: #222;
  margin-bottom: 8px;
}
#exposure-package-form input, #exposure-package-form select {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  margin-bottom: 12px;
  font-size: 1rem;
}
#exposure-package-form button {
  background: #1c0bff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-size: 1.08rem;
  font-weight: 500;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.18s;
}
#exposure-package-form button:hover {
  background: #0a0b3c;
}
@media (max-width: 900px) {
  .profile-content-card {
    padding: 18px 8px 18px 8px;
  }
  #exposure-package-form {
    padding: 12px;
  }
}
@media (max-width: 600px) {
  .profile-section h2 {
    font-size: 1.2rem;
  }
  .profile-card {
    padding: 12px;
    min-width: 160px;
    max-width: 98vw;
  }
  #exposure-package-form {
    padding: 8px;
  }
}
</style>
<div class="profile-flex-layout" style="display:flex;align-items:flex-start;width:100%;max-width:1400px;margin:0 auto;min-height:80vh;">
  <aside class="profile-sidebar" style="margin:0;min-width:220px;background:#fff;border-radius:18px 0 0 18px;box-shadow:0 4px 24px rgba(0,0,0,0.08);padding:32px 0 32px 0;height:100%;position:relative;">
    <nav class="sidebar-nav" style="display:flex;flex-direction:column;gap:12px;">
      <a href="profile.html" class="nav-link active">Profile</a>
      <a href="profile-properties.html" class="nav-link">Properties</a>
      <a href="profile-ads.html" class="nav-link">Advertisements</a>
      <a href="profile-services.html" class="nav-link">Services</a>
      <a href="profile-inbox.html" class="nav-link">Inbox</a>
      <a href="profile-saved.html" class="nav-link">Saved Items</a>
      <a href="analytics.html" class="nav-link">Analytics</a>
      <a href="profile-subscriptions,html" class="nav-link">Packages & Memberships</a>
      <a href="profile-settings.html" class="nav-link">Settings</a>
      <a href="admindashboard.html" class="nav-link" id="nav-admin-dashboard" style="display:none;">Admin Dashboard</a>
      <a href="/auth/logout" class="nav-link" id="nav-logout">Logout</a>
    </nav>
  </aside>
  <section class="profile-content-card" style="flex:1;background:#fff;border-radius:0 18px 18px 0;box-shadow:0 4px 24px rgba(0,0,0,0.08);padding:40px 32px 32px 32px;margin:0;min-height:80vh;">
    <!-- Apple-style Welcome Banner -->
    <div style="background: linear-gradient(90deg,#00ff95 0%,#9cffd6 100%); border-radius: 0 0 32px 32px; margin-bottom: 32px; padding: 48px 48px 48px 48px; display: flex; align-items: center; gap: 32px; position: relative; overflow: hidden; min-height: 180px;">
      <div style="flex:1; position:relative; z-index:2;">
        <div style="font-size: 2.4em; font-weight: 700; color: #1a12ff; margin-bottom: 8px;">
          Welcome <span id="profile-welcome-name" style="color:#191919;">Back!</span>
        </div>
        <div style="font-size: 1.25em; color: #333; font-weight: 500;">
          <span id="profile-welcome-date"></span>
        </div>
      </div>
      <img src="../assets/house element.png" alt="D4Rent" style="position:absolute; right:-70px; top:4px; width:300px; height:300px; border-radius:36px; object-fit:cover; z-index:1; pointer-events:none;">
    </div>

    <!-- Profile Header -->
    <div class="profile-section active" id="section-profile">
      <div class="profile-header">
        <img src="../assets/blank-profile-picture-973460_960_720.webp" alt="Profile Photo" class="profile-picture" id="profile-picture-main">
        <div class="profile-info">
          <div class="profile-fullname" id="profile-fullname-main">Loading...</div>
          <div class="profile-company" id="profile-company-main"></div>
          <div class="profile-profession" id="profile-profession-main"></div>
          <div class="profile-email" id="profile-email-main"></div>
          <div class="profile-phone" id="profile-phone-main"></div>
        </div>
        <button onclick="showEditProfileModal()" style="background: #07ff7f; color: black; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; margin-left: auto; align-self: flex-start; font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,230,204,0.3); transition: all 0.2s ease;">
          <i class="fas fa-edit" style="margin-right: 6px; color: black;"></i>Edit Profile
        </button>
      </div>
    </div>
    
    <!-- Dashboard boxes -->
    <div style="display:flex; gap:32px; justify-content:flex-start; align-items:stretch; margin:32px 0 32px 0; flex-wrap:wrap;">
      <div style="flex:1 1 180px; background:#fff; border-radius:18px; box-shadow:0 2px 12px rgba(28,11,255,0.06); padding:32px 18px; display:flex; flex-direction:column; align-items:center; min-width:160px;">
        <span style="font-size:2.2em; color:#ff4c60; margin-bottom:8px;">üì∑</span>
        <div style="font-size:2em; font-weight:700; color:#222;" id="dashboard-photo-count">0</div>
        <div style="font-size:1.1em; color:#888;">Photos</div>
      </div>
      <div style="flex:1 1 180px; background:#fff; border-radius:18px; box-shadow:0 2px 12px rgba(28,11,255,0.06); padding:32px 18px; display:flex; flex-direction:column; align-items:center; min-width:160px;">
        <span style="font-size:2.2em; color:#1c0bff; margin-bottom:8px;">üè†</span>
        <div style="font-size:2em; font-weight:700; color:#222;" id="dashboard-property-count">0</div>
        <div style="font-size:1.1em; color:#888;">Properties</div>
      </div>
      <div style="flex:1 1 180px; background:#fff; border-radius:18px; box-shadow:0 2px 12px rgba(28,11,255,0.06); padding:32px 18px; display:flex; flex-direction:column; align-items:center; min-width:160px;">
        <span style="font-size:2.2em; color:#00ff95; margin-bottom:8px;">üíæ</span>
        <div style="font-size:2em; font-weight:700; color:#222;" id="dashboard-saved-count">0</div>
        <div style="font-size:1.1em; color:#888;">Saved</div>
      </div>
    </div>

    <!-- Edit Profile Section -->
    <div class="profile-section" id="section-edit">
      <h2>Edit Profile</h2>
      <form id="edit-profile-form" enctype="multipart/form-data">
        <label>Full Name: 
          <input id="edit-full_name" name="full_name" required type="text"/>
        </label>
        <label>Email: 
          <input id="edit-email" name="email" required type="email"/>
        </label>
        <label>Phone Number: 
          <input id="edit-phone_number" name="phone_number" type="text"/>
        </label>
        <label>Role:
          <select id="edit-role" name="role" required>
            <option value="">Select</option>
            <option value="User">User</option>
            <option value="Concierge Agent">Concierge Agent</option>
            <option value="Service Agent">Service Agent</option>
            <option value="Real Estate Agent">Real Estate Agent</option>
          </select>
        </label>
        <label>Profile Picture: 
          <input accept="image/*" id="edit-profile_picture" name="profile_picture" type="file"/>
        </label>
        <label>Company Name: 
          <input id="edit-company" name="company" type="text"/>
        </label>
        <label>Company Logo: 
          <input accept="image/*" id="edit-company_logo" name="company_logo" type="file"/>
        </label>
        <label>Profession: 
          <input id="edit-profession" name="profession" placeholder="e.g. Architect, Banker, Plumber" type="text"/>
        </label>
        <label>Bio:
          <textarea id="edit-bio" name="bio" placeholder="Short description or bio" rows="3"></textarea>
        </label>
        <label>
          <input id="edit-receive_notifications" name="receive_notifications" type="checkbox"/>
          Receive Email Notifications
        </label>
        <label>
          <input id="edit-receive_sms" name="receive_sms" type="checkbox"/>
          Receive SMS Notifications
        </label>
        <button type="submit">Save Changes</button>
      </form>
      <button class="delete-account-btn" id="delete-account-btn" type="button">
        Delete Account
      </button>
    </div>

    <!-- Properties Section -->
    <div class="profile-section" id="section-properties">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>Your Properties</h2>
        <button onclick="showAddPropertyForm()" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Add New Property</button>
      </div>
      
      <!-- Property Contract Form (Step 1) -->
      <div id="property-contract-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Property Listing Agreement</h3>
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
          <h4>Terms and Conditions for Property Listing</h4>
          <p><strong>1. Listing Authority:</strong> By submitting this property listing, you confirm that you are the legal owner or authorized agent of the property and have the right to list it for sale/rent.</p>
          <p><strong>2. Accuracy of Information:</strong> You warrant that all information provided about the property is accurate, complete, and up-to-date. Any false or misleading information may result in listing removal.</p>
          <p><strong>3. Images and Content:</strong> You grant D4Rent.ie the right to use, display, and distribute the images and content you provide for marketing purposes.</p>
          <p><strong>4. Listing Duration:</strong> Property listings remain active for 90 days from submission date unless renewed or removed.</p>
          <p><strong>5. Fees and Commission:</strong> Standard listing fee applies. Additional commission may apply for premium features or completed transactions.</p>
          <p><strong>6. Liability:</strong> D4Rent.ie acts as a platform facilitator and is not responsible for property transactions, disputes, or damages.</p>
          <p><strong>7. Compliance:</strong> You agree to comply with all local property laws, fair housing regulations, and platform guidelines.</p>
          <p><strong>8. Removal Rights:</strong> D4Rent.ie reserves the right to remove listings that violate terms or receive complaints.</p>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="property-contract-agree" required>
            <span>I have read and agree to the Property Listing Terms and Conditions</span>
          </label>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="property-ownership-confirm" required>
            <span>I confirm that I am the legal owner or authorized agent of this property</span>
          </label>
        </div>
        <div style="display: flex; gap: 12px;">
          <button type="button" onclick="hidePropertyContract()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
        </div>
      </div>

      <!-- Add Property Form (Step 2 - Initially Hidden) -->
      <div id="add-property-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Add New Property</h3>
        <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
          üìã <strong>Approval Process:</strong> Your property will be submitted for review and will appear in the "Pending Review" status until approved by our team. Once approved, it will be visible to the public on our platform.
        </div>
        <form id="property-upload-form" enctype="multipart/form-data">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Property Title: 
              <input name="title" required type="text" placeholder="e.g. Beautiful 3-Bed House in Dublin"/>
            </label>
            <label>Price (‚Ç¨): 
              <input name="price" required type="number" min="0" step="0.01" placeholder="e.g. 450000"/>
            </label>
            <label>Rent Price (‚Ç¨/month): 
              <input name="rent_price" type="number" min="0" step="0.01" placeholder="e.g. 2500"/>
            </label>
            <label>Deposit (‚Ç¨): 
              <input name="deposit" type="number" min="0" step="0.01" placeholder="e.g. 5000"/>
            </label>
            <label>Property Type: 
              <select name="property_type" required>
                <option value="">Select Type</option>
                <option value="letting">Letting</option>
                <option value="residential">Residential</option>
                <option value="new home">New Home</option>
                <option value="luxury home">Luxury Home</option>
                <option value="country home">Country Home</option>
                <option value="apartment">Apartment</option>
                <option value="sublet">Sublet</option>
                <option value="new developments">New Developments</option>
                <option value="studio apartment">Studio Apartment</option>
                <option value="student accommodation">Student Accommodation</option>
                <option value="timeshare">Timeshare</option>
                <option value="office">Office</option>
                <option value="restaurant/bar">Restaurant/Bar</option>
                <option value="cafe">Cafe</option>
                <option value="auction">Auction</option>
                <option value="agricultural site">Agricultural Site</option>
                <option value="investment property">Investment Property</option>
                <option value="development site">Development Site</option>
                <option value="short term">Short Term</option>
                <option value="other">Other</option>
              </select>
            </label>
            <label>Status: 
              <select name="status" required>
                <option value="">Select Status</option>
                <option value="for sale">For Sale</option>
                <option value="sale agreed">Sale Agreed</option>
                <option value="sold">Sold</option>
                <option value="to let">To Let</option>
                <option value="letting agreed">Letting Agreed</option>
              </select>
            </label>
            <label>Listing Type: 
              <select name="listing_type" required>
                <option value="">Select Type</option>
                <option value="agent">Agent</option>
                <option value="owner">Owner</option>
                <option value="developer">Developer</option>
              </select>
            </label>
            <label>Bedrooms: 
              <input name="bedrooms" type="number" min="0" max="20" placeholder="e.g. 3"/>
            </label>
            <label>Bathrooms: 
              <input name="bathrooms" type="number" min="0" max="10" step="0.5" placeholder="e.g. 2"/>
            </label>
            <label>Size (sq ft): 
              <input name="size_sqft" type="number" min="0" placeholder="e.g. 1200"/>
            </label>
            <label>Year Built: 
              <input name="year_built" type="number" min="1800" max="2100" placeholder="e.g. 2010"/>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <label>Address: 
              <textarea name="address" rows="2" required placeholder="Full property address"></textarea>
            </label>
            <label>City: 
              <input name="city" type="text" required placeholder="e.g. Dublin"/>
            </label>
            <label>County: 
              <input name="county" type="text" required placeholder="e.g. Dublin"/>
            </label>
            <label>Eircode: 
              <input name="eircode" type="text" maxlength="10" placeholder="e.g. D02 XY45"/>
            </label>
            <label>Energy Rating: 
              <select name="energy_rating">
                <option value="">Select Rating</option>
                <option value="A1">A1</option>
                <option value="A2">A2</option>
                <option value="A3">A3</option>
                <option value="B1">B1</option>
                <option value="B2">B2</option>
                <option value="B3">B3</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
                <option value="C3">C3</option>
                <option value="D1">D1</option>
                <option value="D2">D2</option>
                <option value="E1">E1</option>
                <option value="E2">E2</option>
                <option value="F">F</option>
                <option value="G">G</option>
              </select>
            </label>
            <label>Condition: 
              <select name="condition">
                <option value="">Select Condition</option>
                <option value="New">New</option>
                <option value="Excellent">Excellent</option>
                <option value="Very Good">Very Good</option>
                <option value="Good">Good</option>
                <option value="Fair">Fair</option>
                <option value="Needs Work">Needs Work</option>
              </select>
            </label>
          </div>
          <label>Description: 
            <textarea name="description" rows="4" placeholder="Describe the property in detail..."></textarea>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Heating Type: 
              <input name="heating" type="text" placeholder="e.g. Gas central heating"/>
            </label>
            <label>Parking: 
              <input name="parking" type="text" placeholder="e.g. 2 car driveway"/>
            </label>
            <label>Garden: 
              <select name="garden">
                <option value="">Select Garden</option>
                <option value="None">No Garden</option>
                <option value="Small">Small Garden</option>
                <option value="Medium">Medium Garden</option>
                <option value="Large">Large Garden</option>
                <option value="Front and Back">Front and Back</option>
              </select>
            </label>
            <label>Furnished: 
              <select name="furnished">
                <option value="">Select Furnishing</option>
                <option value="Unfurnished">Unfurnished</option>
                <option value="Part Furnished">Part Furnished</option>
                <option value="Fully Furnished">Fully Furnished</option>
              </select>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Pets Allowed: 
              <select name="pets_allowed">
                <option value="">Select Pet Policy</option>
                <option value="Yes">Pets Allowed</option>
                <option value="No">No Pets</option>
                <option value="Small Pets Only">Small Pets Only</option>
                <option value="Cats Only">Cats Only</option>
                <option value="Dogs Only">Dogs Only</option>
                <option value="Negotiable">Negotiable</option>
              </select>
            </label>
            <label>Smoking Allowed: 
              <select name="smoking_allowed">
                <option value="">Select Smoking Policy</option>
                <option value="No">No Smoking</option>
                <option value="Yes">Smoking Allowed</option>
                <option value="Outside Only">Outside Only</option>
              </select>
            </label>
            <label>Available From: 
              <input name="available_from" type="date"/>
            </label>
            <label>Lease Term: 
              <select name="lease_term">
                <option value="">Select Lease Term</option>
                <option value="Short Term (1-6 months)">Short Term (1-6 months)</option>
                <option value="Medium Term (6-12 months)">Medium Term (6-12 months)</option>
                <option value="Long Term (12+ months)">Long Term (12+ months)</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
          </div>
          <label>Property Images: 
            <input name="image" type="file" accept="image/*" multiple required>
            <small style="color: #666;">Upload multiple images of your property (max 10 files)</small>
          </label>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Add Property</button>
            <button type="button" onclick="hideAddPropertyForm()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>

<script>
// Stripe Checkout logic for 'bundle' only
document.getElementById('ad-upload-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  // Only allow 'bundle' option for now
  const selectedTier = 'bundle';

  // Stripe payment enforcement
  if (!window.hasPaidForBundle) {
    try {
      // Create Stripe Checkout session
      const response = await fetch((typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : 'https://api.d4rent.ie') + '/api/payments/create-checkout-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
        },
        body: JSON.stringify({ productType: 'advertisement', option: selectedTier })
      });

      if (!response.ok) {
        alert('Failed to initiate payment. Please try again.');
        return;
      }
      const data = await response.json();
      if (data && data.checkoutUrl) {
        // Store a flag so user isn't prompted again after payment
        window.hasPaidForBundle = true;
        window.location.href = data.checkoutUrl;
        return;
      } else {
        alert('Payment initiation failed. Please contact support.');
        return;
      }
    } catch (err) {
      alert('Error connecting to payment service.');
      return;
    }
  }

  // If payment is successful, allow ad upload
  const formData = new FormData(this);
  formData.append('status', 'pending');
  formData.append('approved', '0');

  // Debug: Log the form data being sent
  console.log('Advertisement form data being sent:');
  for (let [key, value] of formData.entries()) {
    console.log(`${key}:`, value);
  }

  try {
    const response = await fetch((typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : 'https://api.d4rent.ie') + '/api/advertisements', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
      },
      body: formData
    });

    if (!response.ok) {
      console.error('Advertisement submission failed:', response.status, response.statusText);
      let errorMessage = 'Failed to add advertisement';
      throw new Error(errorMessage);
    }

    const data = await response.json();
    alert('Advertisement submitted successfully! It will be reviewed by our team and published once approved. You will be notified of the status.');

    // Hide form and refresh ads
    hideAddAdForm();
    if (typeof fetchUserAds === 'function') fetchUserAds();

  } catch (error) {
    console.error('Error adding advertisement:', error);
    alert(`Error adding advertisement: ${error.message}. Please check the console for more details.`);
  }
});
</script>
      
      <!-- Edit Property Form (Initially Hidden) -->
      <div id="edit-property-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Edit Property</h3>
        <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
          üíæ <strong>Auto-Save Enabled:</strong> Changes to individual fields are automatically saved as you edit. Look for the save indicators next to each field.
        </div>
        <form id="property-edit-form" enctype="multipart/form-data">
          <input type="hidden" id="edit-property-id" name="property_id">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Property Title: 
              <input id="edit-property-title" name="title" required type="text"/>
            </label>
            <label>Price (‚Ç¨): 
              <input id="edit-property-price" name="price" required type="number" min="0" step="0.01"/>
            </label>
            <label>Rent Price (‚Ç¨/month): 
              <input id="edit-property-rent" name="rent_price" type="number" min="0" step="0.01"/>
            </label>
            <label>Deposit (‚Ç¨): 
              <input id="edit-property-deposit" name="deposit" type="number" min="0" step="0.01"/>
            </label>
            <label>Property Type: 
              <select id="edit-property-type" name="property_type" required>
                <option value="">Select Type</option>
                <option value="letting">Letting</option>
                <option value="residential">Residential</option>
                <option value="new home">New Home</option>
                <option value="luxury home">Luxury Home</option>
                <option value="country home">Country Home</option>
                <option value="apartment">Apartment</option>
                <option value="sublet">Sublet</option>
                <option value="new developments">New Developments</option>
                <option value="studio apartment">Studio Apartment</option>
                <option value="student accommodation">Student Accommodation</option>
                <option value="timeshare">Timeshare</option>
                <option value="office">Office</option>
                <option value="restaurant/bar">Restaurant/Bar</option>
                <option value="cafe">Cafe</option>
                <option value="auction">Auction</option>
                <option value="agricultural site">Agricultural Site</option>
                <option value="investment property">Investment Property</option>
                <option value="development site">Development Site</option>
                <option value="short term">Short Term</option>
                <option value="other">Other</option>
              </select>
            </label>
            <label>Status: 
              <select id="edit-property-status" name="status" required>
                <option value="">Select Status</option>
                <option value="for sale">For Sale</option>
                <option value="sale agreed">Sale Agreed</option>
                <option value="sold">Sold</option>
                <option value="to let">To Let</option>
                <option value="letting agreed">Letting Agreed</option>
              </select>
            </label>
            <label>Listing Type: 
              <select id="edit-property-listing-type" name="listing_type" required>
                <option value="">Select Type</option>
                <option value="agent">Agent</option>
                <option value="owner">Owner</option>
                <option value="developer">Developer</option>
              </select>
            </label>
            <label>Bedrooms: 
              <input id="edit-property-bedrooms" name="bedrooms" type="number" min="0" max="20"/>
            </label>
            <label>Bathrooms: 
              <input id="edit-property-bathrooms" name="bathrooms" type="number" min="0" max="10" step="0.5"/>
            </label>
            <label>Size (sq ft): 
              <input id="edit-property-size" name="size_sqft" type="text" placeholder="e.g. 1200 or 1200 sq ft"/>
            </label>
            <label>Year Built: 
              <input id="edit-property-year-built" name="year_built" type="number" min="1800" max="2100"/>
            </label>
            <label>Video Tour (YouTube or video link):
              <input id="edit-property-video" name="video_tour" type="url" placeholder="https://youtube.com/..." />
            </label>
            <label style="display:flex; align-items:center; gap:8px;">Featured Listing:
              <input id="edit-property-featured" name="featured" type="checkbox" />
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <label>Address: 
              <textarea id="edit-property-address" name="address" rows="2" required></textarea>
            </label>
            <label>City: 
              <input id="edit-property-city" name="city" type="text" required/>
            </label>
            <label>County: 
              <input id="edit-property-county" name="county" type="text" required/>
            </label>
            <label>Eircode: 
              <input id="edit-property-eircode" name="eircode" type="text" maxlength="10"/>
            </label>
            <label>Energy Rating: 
              <select id="edit-property-energy-rating" name="energy_rating">
                <option value="">Select Rating</option>
                <option value="A1">A1</option>
                <option value="A2">A2</option>
                <option value="A3">A3</option>
                <option value="B1">B1</option>
                <option value="B2">B2</option>
                <option value="B3">B3</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
                <option value="C3">C3</option>
                <option value="D1">D1</option>
                <option value="D2">D2</option>
                <option value="E1">E1</option>
                <option value="E2">E2</option>
                <option value="F">F</option>
                <option value="G">G</option>
              </select>
            </label>
            <label>Condition: 
              <select id="edit-property-condition" name="condition">
                <option value="">Select Condition</option>
                <option value="New">New</option>
                <option value="Excellent">Excellent</option>
                <option value="Very Good">Very Good</option>
                <option value="Good">Good</option>
                <option value="Fair">Fair</option>
                <option value="Needs Work">Needs Work</option>
              </select>
            </label>
          </div>
          <label>Description: 
            <textarea id="edit-property-description" name="description" rows="4"></textarea>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Heating Type: 
              <input id="edit-property-heating" name="heating" type="text"/>
            </label>
            <label>Parking: 
              <input id="edit-property-parking" name="parking" type="text"/>
            </label>
            <label>Garden: 
              <select id="edit-property-garden" name="garden">
                <option value="">Select Garden</option>
                <option value="None">No Garden</option>
                <option value="Small">Small Garden</option>
                <option value="Medium">Medium Garden</option>
                <option value="Large">Large Garden</option>
                <option value="Front and Back">Front and Back</option>
              </select>
            </label>
            <label>Furnished: 
              <select id="edit-property-furnished" name="furnished">
                <option value="">Select Furnishing</option>
                <option value="Unfurnished">Unfurnished</option>
                <option value="Part Furnished">Part Furnished</option>
                <option value="Fully Furnished">Fully Furnished</option>
              </select>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Pets Allowed: 
              <select id="edit-property-pets" name="pets_allowed">
                <option value="">Select Pet Policy</option>
                <option value="Yes">Pets Allowed</option>
                <option value="No">No Pets</option>
                <option value="Small Pets Only">Small Pets Only</option>
                <option value="Cats Only">Cats Only</option>
                <option value="Dogs Only">Dogs Only</option>
                <option value="Negotiable">Negotiable</option>
              </select>
            </label>
            <label>Smoking Allowed: 
              <select id="edit-property-smoking" name="smoking_allowed">
                <option value="">Select Smoking Policy</option>
                <option value="No">No Smoking</option>
                <option value="Yes">Smoking Allowed</option>
                <option value="Outside Only">Outside Only</option>
              </select>
            </label>
            <label>Available From: 
              <input id="edit-property-available" name="available_from" type="date"/>
            </label>
            <label>Lease Term: 
              <select id="edit-property-lease" name="lease_term">
                <option value="">Select Lease Term</option>
                <option value="Short Term (1-6 months)">Short Term (1-6 months)</option>
                <option value="Medium Term (6-12 months)">Medium Term (6-12 months)</option>
                <option value="Long Term (12+ months)">Long Term (12+ months)</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
          </div>
          <label>New Images (leave empty to keep existing): 
            <input name="images" type="file" accept="image/*" multiple>
          </label>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Update Property</button>
            <button type="button" onclick="hideEditPropertyForm()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>
      
      <div class="profile-card-grid" id="user-listings-grid">
        <!-- Properties will be loaded here -->
        <!-- Properties will be loaded here -->
      </div>
    </div>

    <!-- Ads Section -->
    <div class="profile-section" id="section-ads">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>Your Advertisements</h2>
        <button onclick="showAddAdForm()" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Add New Advertisement</button>
      </div>
      
      <!-- Advertisement Contract Form (Step 1) -->
      <div id="ad-contract-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Advertisement Listing Agreement</h3>
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
          <h4>Terms and Conditions for Advertisement Listing</h4>
          <p><strong>1. Advertisement Authority:</strong> You confirm that you have the right to advertise the services/products described in your listing.</p>
          <p><strong>2. Content Accuracy:</strong> All information in your advertisement must be truthful, accurate, and not misleading. False advertising may result in immediate removal.</p>
          <p><strong>3. Legal Compliance:</strong> Your advertisement must comply with all applicable laws, including consumer protection, advertising standards, and industry regulations.</p>
          <p><strong>4. Prohibited Content:</strong> No illegal services, discriminatory content, or misleading claims are permitted.</p>
          <p><strong>5. Listing Duration:</strong> Advertisements remain active for 60 days unless renewed or removed.</p>
          <p><strong>6. Platform Rights:</strong> D4Rent.ie reserves the right to edit, remove, or reject advertisements that violate platform policies.</p>
          <p><strong>7. User Responsibility:</strong> You are responsible for managing inquiries, providing quoted services, and handling customer relations.</p>
          <p><strong>8. Fees:</strong> Advertisement listing fees apply as per current pricing structure.</p>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="ad-contract-agree" required>
            <span>I have read and agree to the Advertisement Listing Terms and Conditions</span>
          </label>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="ad-legal-confirm" required>
            <span>I confirm that my advertisement complies with all applicable laws and regulations</span>
          </label>
        </div>
        <div style="display: flex; gap: 12px;">
          <button type="button" onclick="proceedToAdForm()" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Accept & Continue</button>
          <button type="button" onclick="hideAdContract()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
        </div>
      </div>

      <!-- Add Advertisement Form (Step 2 - Initially Hidden) -->
      <div id="add-ad-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Add New Advertisement</h3>
        <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
          üìã <strong>Approval Process:</strong> Your advertisement will be submitted for review and will appear in the "Pending Review" status until approved by our team. Once approved, it will be visible to the public on our platform.
        </div>
        <form id="ad-upload-form" enctype="multipart/form-data">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Advertisement Title: 
              <input name="title" required type="text" placeholder="e.g. Professional Cleaning Service"/>
            </label>
            <label>Category: 
              <select name="category" required>
                <option value="">Select Category</option>
                <option value="Property Services">Property Services</option>
                <option value="Home Improvement">Home Improvement</option>
                <option value="Cleaning">Cleaning</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Real Estate">Real Estate</option>
                <option value="Legal Services">Legal Services</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Moving Services">Moving Services</option>
                <option value="Landscaping">Landscaping</option>
                <option value="Security Services">Security Services</option>
                <option value="Insurance">Insurance</option>
                <option value="Consulting">Consulting</option>
                <option value="Other">Other</option>
              </select>
            </label>
            <label>Sub-Category: 
              <input name="sub_category" type="text" placeholder="e.g. Residential Cleaning"/>
            </label>
            <label>Target Audience: 
              <select name="target_audience">
                <option value="">Select Target Audience</option>
                <option value="Homeowners">Homeowners</option>
                <option value="Landlords">Landlords</option>
                <option value="Tenants">Tenants</option>
                <option value="Property Managers">Property Managers</option>
                <option value="Real Estate Agents">Real Estate Agents</option>
                <option value="Businesses">Businesses</option>
                <option value="General Public">General Public</option>
              </select>
            </label>
            <label>Price: 
              <input name="price" type="text" placeholder="e.g. ‚Ç¨50/hour or Contact for quote"/>
            </label>
            <label>Currency: 
              <select name="currency">
                <option value="EUR">EUR (‚Ç¨)</option>
                <option value="USD">USD ($)</option>
                <option value="GBP">GBP (¬£)</option>
              </select>
            </label>
            <label>Contact Method: 
              <select name="contact_method" required>
                <option value="">Select Contact Method</option>
                <option value="phone">Phone</option>
                <option value="email">Email</option>
                <option value="both">Phone & Email</option>
                <option value="website">Website Form</option>
              </select>
            </label>
            <label>Phone Number: 
              <input name="phone_number" type="tel" placeholder="e.g. 01-234-5678"/>
            </label>
            <label>Email: 
              <input name="email" type="email" placeholder="contact@example.com"/>
            </label>
            <label>Website Link: 
              <input name="link" type="url" placeholder="https://your-website.com"/>
            </label>
          </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          const adForm = document.getElementById('ad-upload-form');
          adForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(adForm);
            // Step 1: Save ad as pending/unpaid
            let adRes;
            try {
              adRes = await fetch('/api/ads', {
                method: 'POST',
                body: formData,
                credentials: 'include'
              });
            } catch (err) {
              alert('Failed to save advertisement.');
              return;
            }
            if (!adRes.ok) {
              alert('Failed to save advertisement.');
              return;
            }
            const adData = await adRes.json();
            // Step 2: Request Stripe Checkout session
            let stripeRes;
            try {
              stripeRes = await fetch('/api/payments/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ productType: 'ad', option: 'ad_upload', adId: adData.id })
              });
            } catch (err) {
              alert('Failed to start payment.');
              return;
            }
            if (!stripeRes.ok) {
              alert('Failed to start payment.');
              return;
            }
            const stripeData = await stripeRes.json();
            if (stripeData.url) {
              window.location.href = stripeData.url;
            } else {
              alert('Payment link not received.');
            }
          });
        });
        </script>
          <label>Bio/Description: 
            <textarea name="bio" rows="4" placeholder="Describe your advertisement in detail..." required></textarea>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Business Address: 
              <input name="address" type="text" placeholder="Your business address"/>
            </label>
            <label>Target Location: 
              <input name="target_location" type="text" placeholder="e.g. Dublin, Ireland"/>
            </label>
            <label>Service Radius (km): 
              <input name="service_radius" type="number" min="0" placeholder="e.g. 25"/>
            </label>
            <label>Business Hours: 
              <input name="business_hours" type="text" placeholder="e.g. Mon-Fri 9AM-5PM"/>
            </label>
            <label>Response Time: 
              <select name="response_time">
                <option value="">Select Response Time</option>
                <option value="Same Day">Same Day</option>
                <option value="24 Hours">Within 24 Hours</option>
                <option value="48 Hours">Within 48 Hours</option>
                <option value="1 Week">Within 1 Week</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Years in Business: 
              <input name="years_in_business" type="number" min="0" max="50" placeholder="e.g. 5"/>
            </label>
            <label>License/Registration Number: 
              <input name="license_number" type="text" placeholder="License or registration number"/>
            </label>
            <label>Insurance Status: 
              <select name="insurance_status">
                <option value="">Select Insurance Status</option>
                <option value="Fully Insured">Fully Insured</option>
                <option value="Public Liability">Public Liability Only</option>
                <option value="Professional Indemnity">Professional Indemnity</option>
                <option value="Not Insured">Not Insured</option>
              </select>
            </label>
            <label>Emergency Service Available: 
              <select name="emergency_service">
                <option value="">Emergency Service</option>
                <option value="Yes">Yes - 24/7 Emergency</option>
                <option value="Limited">Limited Emergency Hours</option>
                <option value="No">No Emergency Service</option>
              </select>
            </label>
          </div>
          <label>Advertisement Photo: 
            <input name="photo" type="file" accept="image/*">
            <small style="color: #666;">Upload a photo showcasing your service/business</small>
          </label>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Add Advertisement</button>
            <button type="button" onclick="hideAddAdForm()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>
      
      <!-- Edit Advertisement Form (Initially Hidden) -->
      <div id="edit-ad-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Edit Advertisement</h3>
        <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
          üíæ <strong>Auto-Save Enabled:</strong> Changes to individual fields are automatically saved as you edit. Look for the save indicators next to each field.
        </div>
        <form id="ad-edit-form" enctype="multipart/form-data">
          <input type="hidden" id="edit-ad-id" name="ad_id">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Advertisement Title: 
              <input id="edit-ad-title" name="title" required type="text"/>
            </label>
            <label>Category: 
              <select id="edit-ad-category" name="category" required>
                <option value="">Select Category</option>
                <option value="Property Services">Property Services</option>
                <option value="Home Improvement">Home Improvement</option>
                <option value="Cleaning">Cleaning</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Real Estate">Real Estate</option>
                <option value="Legal Services">Legal Services</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Moving Services">Moving Services</option>
                <option value="Landscaping">Landscaping</option>
                <option value="Security Services">Security Services</option>
                <option value="Insurance">Insurance</option>
                <option value="Consulting">Consulting</option>
                <option value="Other">Other</option>
              </select>
            </label>
            <label>Sub-Category: 
              <input id="edit-ad-sub-category" name="sub_category" type="text"/>
            </label>
            <label>Target Audience: 
              <select id="edit-ad-target-audience" name="target_audience">
                <option value="">Select Target Audience</option>
                <option value="Homeowners">Homeowners</option>
                <option value="Landlords">Landlords</option>
                <option value="Tenants">Tenants</option>
                <option value="Property Managers">Property Managers</option>
                <option value="Real Estate Agents">Real Estate Agents</option>
                <option value="Businesses">Businesses</option>
                <option value="General Public">General Public</option>
              </select>
            </label>
            <label>Price: 
              <input id="edit-ad-price" name="price" type="text"/>
            </label>
            <label>Currency: 
              <select id="edit-ad-currency" name="currency">
                <option value="EUR">EUR (‚Ç¨)</option>
                <option value="USD">USD ($)</option>
                <option value="GBP">GBP (¬£)</option>
              </select>
            </label>
            <label>Contact Method: 
              <select id="edit-ad-contact" name="contact_method" required>
                <option value="">Select Contact Method</option>
                <option value="phone">Phone</option>
                <option value="email">Email</option>
                <option value="both">Phone & Email</option>
                <option value="website">Website Form</option>
              </select>
            </label>
            <label>Phone Number: 
              <input id="edit-ad-phone-number" name="phone_number" type="tel"/>
            </label>
            <label>Email: 
              <input id="edit-ad-email" name="email" type="email"/>
            </label>
            <label>Website Link: 
              <input id="edit-ad-link" name="link" type="url"/>
            </label>
          </div>
          <label>Bio/Description: 
            <textarea id="edit-ad-bio" name="bio" rows="4" required></textarea>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Business Address: 
              <input id="edit-ad-address" name="address" type="text"/>
            </label>
            <label>Target Location: 
              <input id="edit-ad-target-location" name="target_location" type="text"/>
            </label>
            <label>Service Radius (km): 
              <input id="edit-ad-service-radius" name="service_radius" type="number" min="0"/>
            </label>
            <label>Business Hours: 
              <input id="edit-ad-business-hours" name="business_hours" type="text"/>
            </label>
            <label>Response Time: 
              <select id="edit-ad-response-time" name="response_time">
                <option value="">Select Response Time</option>
                <option value="Same Day">Same Day</option>
                <option value="24 Hours">Within 24 Hours</option>
                <option value="48 Hours">Within 48 Hours</option>
                <option value="1 Week">Within 1 Week</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Years in Business: 
              <input id="edit-ad-years-business" name="years_in_business" type="number" min="0" max="50"/>
            </label>
            <label>License/Registration Number: 
              <input id="edit-ad-license" name="license_number" type="text"/>
            </label>
            <label>Insurance Status: 
              <select id="edit-ad-insurance" name="insurance_status">
                <option value="">Select Insurance Status</option>
                <option value="Fully Insured">Fully Insured</option>
                <option value="Public Liability">Public Liability Only</option>
                <option value="Professional Indemnity">Professional Indemnity</option>
                <option value="Not Insured">Not Insured</option>
              </select>
            </label>
            <label>Emergency Service Available: 
              <select id="edit-ad-emergency" name="emergency_service">
                <option value="">Emergency Service</option>
                <option value="Yes">Yes - 24/7 Emergency</option>
                <option value="Limited">Limited Emergency Hours</option>
                <option value="No">No Emergency Service</option>
              </select>
            </label>
          </div>
          <label>New Photo (leave empty to keep existing): 
            <input name="photo" type="file" accept="image/*">
          </label>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Update Advertisement</button>
            <button type="button" onclick="hideEditAdForm()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>
      
      <div class="profile-card-grid" id="user-advertisements-grid">
        <!-- Advertisements will be loaded here -->
        <p style="color: #888; text-align: center; grid-column: 1/-1;">No advertisements yet. <a href="/public/2ndbase/index2.html#advertisements" style="color: #1c0bff; text-decoration: underline;">View All Advertisements</a></p>
      </div>
    </div>

    <!-- Services Section -->
    <div class="profile-section" id="section-services">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>Your Services</h2>
        <button onclick="showAddServiceForm()" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Add New Service</button>
      </div>

      <!-- Add Service Form (Step 2 - Initially Hidden) -->
      <div id="add-service-form" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(248,250,252,0.98); z-index: 9999; padding: 0; border-radius: 0; margin: 0; overflow-y: auto;">
        <h3>Add New Service</h3>
        <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
          üìã <strong>Approval Process:</strong> Your service will be submitted for review and will appear in the "Pending Review" status until approved by our team. Once approved, it will be visible to the public on our platform.
        </div>
        <form id="service-upload-form" enctype="multipart/form-data">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Service Name: 
              <input name="name" required type="text" placeholder="e.g. Property Management"/>
            </label>
            <label>Service Category: 
              <select name="category" required>
                <option value="">Select Category</option>
                <option value="Property Management">Property Management</option>
                <option value="Maintenance & Repairs">Maintenance & Repairs</option>
                <option value="Cleaning Services">Cleaning Services</option>
                <option value="Real Estate Services">Real Estate Services</option>
                <option value="Legal Services">Legal Services</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Home Improvement">Home Improvement</option>
                <option value="Landscaping & Gardening">Landscaping & Gardening</option>
                <option value="Security Services">Security Services</option>
                <option value="Moving Services">Moving Services</option>
                <option value="Insurance Services">Insurance Services</option>
                <option value="Consulting">Consulting</option>
                <option value="Other">Other</option>
              </select>
            </label>
            <label>Service Type: 
              <select name="service_type" required>
                <option value="">Select Type</option>
                <option value="One-time Service">One-time Service</option>
                <option value="Recurring Service">Recurring Service</option>
                <option value="Contract Service">Contract Service</option>
                <option value="Emergency Service">Emergency Service</option>
                <option value="Consultation">Consultation</option>
              </select>
            </label>
            <label>Price Structure: 
              <select name="price_structure">
                <option value="">Select Structure</option>
                <option value="Fixed Price">Fixed Price</option>
                <option value="Hourly Rate">Hourly Rate</option>
                <option value="Daily Rate">Daily Rate</option>
                <option value="Project Based">Project Based</option>
                <option value="Contact for Quote">Contact for Quote</option>
              </select>
            </label>
            <label>Price Range: 
              <input name="price_range" type="text" placeholder="e.g. ‚Ç¨100-500 or ‚Ç¨50/hour"/>
            </label>
            <label>Availability: 
              <select name="availability" required>
                <option value="">Select Availability</option>
                <option value="24/7">24/7</option>
                <option value="Business Hours">Business Hours (9-5)</option>
                <option value="Weekdays">Weekdays Only</option>
                <option value="Weekends">Weekends Available</option>
                <option value="Evening Hours">Evening Hours</option>
                <option value="By Appointment">By Appointment Only</option>
                <option value="Emergency Callout">Emergency Callout</option>
              </select>
            </label>
            <label>Response Time: 
              <select name="response_time">
                <option value="">Select Response Time</option>
                <option value="Same Day">Same Day</option>
                <option value="24 Hours">Within 24 Hours</option>
                <option value="48 Hours">Within 48 Hours</option>
                <option value="1 Week">Within 1 Week</option>
                <option value="2 Weeks">Within 2 Weeks</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
            <label>Years of Experience: 
              <input name="experience_years" type="number" min="0" max="50" placeholder="e.g. 5"/>
            </label>
          </div>
          <label>Service Description: 
            <textarea name="description" rows="4" placeholder="Describe your service in detail..." required></textarea>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Service Areas: 
              <input name="service_areas" type="text" placeholder="e.g. Dublin, Cork, Galway"/>
            </label>
            <label>Website URL: 
              <input name="website" type="url" placeholder="https://your-website.com"/>
            </label>
            <label>Phone Number: 
              <input name="phone" type="tel" placeholder="e.g. 01-234-5678"/>
            </label>
            <label>Email: 
              <input name="email" type="email" placeholder="service@example.com"/>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Certifications: 
              <input name="certifications" type="text" placeholder="e.g. ISO 9001, Trade Licenses"/>
            </label>
            <label>Insurance: 
              <select name="insurance">
                <option value="">Insurance Status</option>
                <option value="Fully Insured">Fully Insured</option>
                <option value="Public Liability">Public Liability Only</option>
                <option value="Professional Indemnity">Professional Indemnity</option>
                <option value="Not Insured">Not Insured</option>
              </select>
            </label>
          </div>
          <label>Service Photo: 
            <input name="photo" type="file" accept="image/*">
          </label>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Add Service</button>
            <button type="button" onclick="hideAddServiceForm()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>
      
      <!-- Edit Service Form (Initially Hidden) -->
      <div id="edit-service-form" style="display: none; background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <h3>Edit Service</h3>
        <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
          üíæ <strong>Auto-Save Enabled:</strong> Changes to individual fields are automatically saved as you edit. Look for the save indicators next to each field.
        </div>
        <form id="service-edit-form" enctype="multipart/form-data">
          <input type="hidden" id="edit-service-id" name="service_id">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Service Name: 
              <input id="edit-service-name" name="name" required type="text"/>
            </label>
            <label>Service Category: 
              <select id="edit-service-category" name="category" required>
                <option value="">Select Category</option>
                <option value="Property Management">Property Management</option>
                <option value="Maintenance & Repairs">Maintenance & Repairs</option>
                <option value="Cleaning Services">Cleaning Services</option>
                <option value="Real Estate Services">Real Estate Services</option>
                <option value="Legal Services">Legal Services</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Home Improvement">Home Improvement</option>
                <option value="Landscaping & Gardening">Landscaping & Gardening</option>
                <option value="Security Services">Security Services</option>
                <option value="Moving Services">Moving Services</option>
                <option value="Insurance Services">Insurance Services</option>
                <option value="Consulting">Consulting</option>
                <option value="Other">Other</option>
              </select>
            </label>
            <label>Service Type: 
              <select id="edit-service-type" name="service_type" required>
                <option value="">Select Type</option>
                <option value="One-time Service">One-time Service</option>
                <option value="Recurring Service">Recurring Service</option>
                <option value="Contract Service">Contract Service</option>
                <option value="Emergency Service">Emergency Service</option>
                <option value="Consultation">Consultation</option>
              </select>
            </label>
            <label>Price Structure: 
              <select id="edit-service-price-structure" name="price_structure">
                <option value="">Select Structure</option>
                <option value="Fixed Price">Fixed Price</option>
                <option value="Hourly Rate">Hourly Rate</option>
                <option value="Daily Rate">Daily Rate</option>
                <option value="Project Based">Project Based</option>
                <option value="Contact for Quote">Contact for Quote</option>
              </select>
            </label>
            <label>Price Range: 
              <input id="edit-service-price" name="price_range" type="text"/>
            </label>
            <label>Availability: 
              <select id="edit-service-availability" name="availability" required>
                <option value="">Select Availability</option>
                <option value="24/7">24/7</option>
                <option value="Business Hours">Business Hours (9-5)</option>
                <option value="Weekdays">Weekdays Only</option>
                <option value="Weekends">Weekends Available</option>
                <option value="Evening Hours">Evening Hours</option>
                <option value="By Appointment">By Appointment Only</option>
                <option value="Emergency Callout">Emergency Callout</option>
              </select>
            </label>
            <label>Response Time: 
              <select id="edit-service-response-time" name="response_time">
                <option value="">Select Response Time</option>
                <option value="Same Day">Same Day</option>
                <option value="24 Hours">Within 24 Hours</option>
                <option value="48 Hours">Within 48 Hours</option>
                <option value="1 Week">Within 1 Week</option>
                <option value="2 Weeks">Within 2 Weeks</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
            <label>Years of Experience: 
              <input id="edit-service-experience" name="experience_years" type="number" min="0" max="50"/>
            </label>
            <label>Video Tour (YouTube or video link):
              <input id="edit-service-video" name="video_tour" type="url" placeholder="https://youtube.com/..." />
            </label>
            <label style="display:flex; align-items:center; gap:8px;">Featured Service:
              <input id="edit-service-featured" name="featured" type="checkbox" />
            </label>
          </div>
          <label>Service Description: 
            <textarea id="edit-service-description" name="description" rows="4" required></textarea>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Service Areas: 
              <input id="edit-service-areas" name="service_areas" type="text"/>
            </label>
            <label>Website URL: 
              <input id="edit-service-website" name="website" type="url"/>
            </label>
            <label>Phone Number: 
              <input id="edit-service-phone" name="phone" type="tel"/>
            </label>
            <label>Email: 
              <input id="edit-service-email" name="email" type="email"/>
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Certifications: 
              <input id="edit-service-certifications" name="certifications" type="text"/>
            </label>
            <label>Insurance: 
              <select id="edit-service-insurance" name="insurance">
                <option value="">Insurance Status</option>
                <option value="Fully Insured">Fully Insured</option>
                <option value="Public Liability">Public Liability Only</option>
                <option value="Professional Indemnity">Professional Indemnity</option>
                <option value="Not Insured">Not Insured</option>
              </select>
            </label>
          </div>
          <label>New Photo (leave empty to keep existing): 
            <input name="photo" type="file" accept="image/*">
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <label>Service Name: 
              <input id="edit-service-name" name="name" required type="text"/>
            </label>
            <label>Service Category: 
              <select id="edit-service-category" name="category" required>
                <option value="">Select Category</option>
                <option value="Property Management">Property Management</option>
                <option value="Maintenance & Repairs">Maintenance & Repairs</option>
                <option value="Cleaning Services">Cleaning Services</option>
                <option value="Real Estate Services">Real Estate Services</option>
                <option value="Legal Services">Legal Services</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Home Improvement">Home Improvement</option>
                <option value="Landscaping & Gardening">Landscaping & Gardening</option>
                <option value="Security Services">Security Services</option>
                <option value="Moving Services">Moving Services</option>
                <option value="Insurance Services">Insurance Services</option>
                <option value="Consulting">Consulting</option>
                <option value="Other">Other</option>
              </select>
            </label>
            <label>Service Type: 
              <select id="edit-service-type" name="service_type" required>
                <option value="">Select Type</option>
                <option value="One-time Service">One-time Service</option>
                <option value="Recurring Service">Recurring Service</option>
                <option value="Contract Service">Contract Service</option>
                <option value="Emergency Service">Emergency Service</option>
                <option value="Consultation">Consultation</option>
              </select>
            </label>
            <label>Price Structure: 
              <select id="edit-service-price-structure" name="price_structure">
                <option value="">Select Structure</option>
                <option value="Fixed Price">Fixed Price</option>
                <option value="Hourly Rate">Hourly Rate</option>
                <option value="Daily Rate">Daily Rate</option>
                <option value="Project Based">Project Based</option>
                <option value="Contact for Quote">Contact for Quote</option>
              </select>
            </label>
            <label>Price Range: 
              <input id="edit-service-price" name="price_range" type="text"/>
            </label>
            <label>Availability: 
              <select id="edit-service-availability" name="availability" required>
                <option value="">Select Availability</option>
                <option value="24/7">24/7</option>
                <option value="Business Hours">Business Hours (9-5)</option>
                <option value="Weekdays">Weekdays Only</option>
                <option value="Weekends">Weekends Available</option>
                <option value="Evening Hours">Evening Hours</option>
                <option value="By Appointment">By Appointment Only</option>
                <option value="Emergency Callout">Emergency Callout</option>
              </select>
            </label>
            <label>Response Time: 
              <select id="edit-service-response-time" name="response_time">
                <option value="">Select Response Time</option>
                <option value="Same Day">Same Day</option>
                <option value="24 Hours">Within 24 Hours</option>
                <option value="48 Hours">Within 48 Hours</option>
                <option value="1 Week">Within 1 Week</option>
                <option value="2 Weeks">Within 2 Weeks</option>
                <option value="Flexible">Flexible</option>
              </select>
            </label>
            <label>Years of Experience: 
              <input id="edit-service-experience" name="experience_years" type="number" min="0" max="50"/>
            </label>
          </div>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Update Service</button>
            <button type="button" onclick="hideEditServiceForm()" style="background: #ccc; color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        </form>
      </div>
      
      <div class="profile-card-grid" id="user-services-grid">
        <!-- Search & Filters (Services) -->
        <div class="search-filter-bar" style="display:flex;flex-wrap:wrap;align-items:center;gap:16px;margin-bottom:24px;background:#f4f8fc;padding:16px 20px;border-radius:10px;box-shadow:0 2px 8px #e0e7ef;">
          <input type="text" id="service-search-keyword" placeholder="üîç Search by keyword or name" style="flex:2;min-width:180px;padding:8px 12px;border-radius:6px;border:1px solid #cbd5e1;">
          <select id="service-search-category" style="flex:1;min-width:120px;padding:8px 12px;border-radius:6px;border:1px solid #cbd5e1;">
            <option value="">Category</option>
            <option value="Property Management">Property Management</option>
            <option value="Maintenance & Repairs">Maintenance & Repairs</option>
            <option value="Cleaning Services">Cleaning Services</option>
            <option value="Real Estate Services">Real Estate Services</option>
            <option value="Other">Other</option>
          </select>
          <input type="number" id="service-search-price-min" placeholder="Min ‚Ç¨" style="width:90px;padding:8px 12px;border-radius:6px;border:1px solid #cbd5e1;">
          <input type="number" id="service-search-price-max" placeholder="Max ‚Ç¨" style="width:90px;padding:8px 12px;border-radius:6px;border:1px solid #cbd5e1;">
          <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
            <input type="checkbox" id="service-search-featured">
            Featured Only
          </label>
          <button type="button" onclick="searchServices()" style="background:#1c0bff;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Search</button>
        </div>
        <!-- Map Integration Placeholder -->
        <div id="service-map-placeholder" style="width:100%;height:220px;background:#e8f4fd;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#888;font-size:18px;margin-bottom:24px;">
          üó∫Ô∏è Map search coming soon
        </div>
        <p style="color: #888; text-align: center; grid-column: 1/-1;">No services yet. <a href="/public/2ndbase/services2.html" style="color: #1c0bff; text-decoration: underline;">View All Services</a></p>
      </div>
    </div>

    <!-- Saved Section -->
    <div class="profile-section" id="section-saved">
      <h2>Saved Properties</h2>
      <div class="profile-card-grid" id="saved-properties-grid">
        <!-- Saved properties will be loaded here -->
      </div>
      
      <h2 style="margin-top: 40px;">Saved Agents</h2>
      <div class="profile-card-grid" id="saved-agents-grid">
        <!-- Saved agents will be loaded here -->
      </div>
    </div>

    <!-- Analytics Section -->
    <div class="profile-section" id="section-analytics">
      <h2>Analytics</h2>
      <div style="padding:24px 0;color:#888;text-align:center;">
        Analytics feature coming soon.
      </div>
    </div>

<!-- Packages and Memberships Section -->
<div class="profile-section" id="section-exposure" style="display:none;">
  <h2 style="margin-top:0;">Packages and Memberships</h2>
  <!-- Membership Cards Horizontal Row -->
  <div style="display: flex; flex-direction: row; gap: 36px; width:100%; margin-bottom: 36px; justify-content: center;">
      <div class="membership-tier-card" style="background:#f8fafc; border-radius:12px; box-shadow:0 2px 8px #0001; padding:28px 20px; min-width:220px; max-width:320px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:space-between;">
        <div style="margin-bottom:10px;">
          <svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#e0e0e0"/></svg>
        </div>
        <h3>Free</h3>
        <div style="margin: 12px 0;">
          <div style="font-size:22px; font-weight:600; color:#888;">‚Ç¨0 / month</div>
          <ul style="font-size:14px; color:#666; margin-top:6px; text-align:left; list-style:none; padding:0;">
            <li>‚úîÔ∏è Post listings & services</li>
            <li>‚úîÔ∏è Access basic features</li>
            <li>‚ùå No analytics</li>
            <li>‚ùå No account boost/featured</li>
            <li>‚ùå Ads shown on your dashboard</li>
            <li>‚ùå Standard exposure package pricing</li>
          </ul>
        </div>
        <div style="margin-top:16px; color:#635bff; font-weight:600; font-size:16px;">Current</div>
      </div>
      <div class="membership-tier-card" style="background:#f8fafc; border-radius:12px; box-shadow:0 2px 8px #0001; padding:28px 20px; min-width:220px; max-width:320px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:space-between;">
        <div style="margin-bottom:10px;">
          <svg width="32" height="32" viewBox="0 0 32 32">
            <circle cx="16" cy="16" r="16" fill="#7f1fff"/>
            <polygon points="16,7 18.09,13.26 24.18,13.27 19.54,16.97 21.63,23.23 16,19.53 10.37,23.23 12.46,16.97 7.82,13.27 13.91,13.26" fill="#fff"/>
          </svg>
        </div>
        <h3>Greia Pro</h3>
        <div style="margin: 12px 0;">
          <div style="font-size:22px; font-weight:600; color:#635bff;">‚Ç¨29 / month</div>
          <ul style="font-size:14px; color:#666; margin-top:6px; text-align:left; list-style:none; padding:0;">
            <li>‚úîÔ∏è 50% off all exposure packages</li>
            <li>‚úîÔ∏è Featured account status</li>
            <li>‚úîÔ∏è Boosted listings (properties & services)</li>
            <li>‚úîÔ∏è Access to analytics</li>
            <li>‚úîÔ∏è Priority support</li>
          </ul>
        </div>
        <button class="profile-card-btn" style="margin-top:16px; background:#635bff;" onclick="openProSignupModal()">Learn More & Purchase</button>
      </div>
    </div>
  <!-- Exposure Package Cards Horizontal Row -->
  <div style="display: flex; flex-direction: row; gap: 36px; width:100%; justify-content: center;">
      <div class="exposure-tier-card" style="background:#f8fafc; border-radius:12px; box-shadow:0 2px 8px #0001; padding:28px 20px; min-width:220px; max-width:320px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:space-between;">
        <div style="margin-bottom:10px;">
          <svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="url(#silverGradient)"/><defs><linearGradient id="silverGradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#bfc1c2"/><stop offset="100%" stop-color="#e0e0e0"/></linearGradient></defs></svg>
        </div>
        <h3>Silver</h3>
        <div style="margin: 12px 0;">
          <div style="font-size:22px; font-weight:600; color:#888;">‚Ç¨100</div>
          <div style="font-size:14px; color:#666; margin-top:6px;">Standard listing exposure<br><span style="color:#635bff;font-size:13px;">‚Ç¨50 for Greia Pro members</span></div>
        </div>
        <button class="profile-card-btn" style="margin-top:16px;" onclick="openExposureModal('Silver')">Purchase</button>
      </div>
      <div class="exposure-tier-card" style="background:#f8fafc; border-radius:12px; box-shadow:0 2px 8px #0001; padding:28px 20px; min-width:220px; max-width:320px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:space-between;">
        <div style="margin-bottom:10px;">
          <svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="url(#goldGradient)"/><defs><linearGradient id="goldGradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ffb300"/></linearGradient></defs></svg>
        </div>
        <h3>Gold</h3>
        <div style="margin: 12px 0;">
          <div style="font-size:22px; font-weight:600; color:#888;">‚Ç¨250</div>
          <div style="font-size:14px; color:#666; margin-top:6px;">Featured placement & social media push<br><span style="color:#635bff;font-size:13px;">‚Ç¨125 for Greia Pro members</span></div>
        </div>
        <button class="profile-card-btn" style="margin-top:16px;" onclick="openExposureModal('Gold')">Purchase</button>
      </div>
      <div class="exposure-tier-card" style="background:#f8fafc; border-radius:12px; box-shadow:0 2px 8px #0001; padding:28px 20px; min-width:220px; max-width:320px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:space-between;">
        <div style="margin-bottom:10px;">
          <svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="url(#purpleGradient)"/><defs><linearGradient id="purpleGradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#a259ff"/><stop offset="100%" stop-color="#7f1fff"/></linearGradient></defs></svg>
        </div>
        <h3>Platinum</h3>
        <div style="margin: 12px 0;">
          <div style="font-size:22px; font-weight:600; color:#888;">‚Ç¨500</div>
          <div style="font-size:14px; color:#666; margin-top:6px;">Maximum exposure, homepage banner<br><span style="color:#635bff;font-size:13px;">‚Ç¨250 for Greia Pro members</span></div>
        </div>
        <button class="profile-card-btn" style="margin-top:16px;" onclick="openExposureModal('Platinum')">Purchase</button>
      </div>
    </div>

</div>

    <!-- Settings Section -->
    <div class="profile-section" id="section-settings">
      <h2>Settings</h2>
      <form id="settings-form" style="max-width:480px;margin:0 auto;background:#f8fafc;padding:24px;border-radius:12px;box-shadow:0 2px 8px #0001;">
        <h3 style="margin-top:0;">Notification Preferences</h3>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <input type="checkbox" id="settings-notifications" name="receive_notifications">
          Receive Email Notifications
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <input type="checkbox" id="settings-sms" name="receive_sms">
          Receive SMS Notifications
        </label>
        <label>
  <input type="checkbox" id="show-email-checkbox"> Show my email to others
</label>
<label>
  <input type="checkbox" id="show-phone-checkbox"> Show my phone to others
</label>
        <button type="submit" style="background:#1c0bff;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;">Save Preferences</button>
        <hr style="margin:32px 0;">
        <h3>Change Password</h3>
        <label style="display:block;margin-bottom:12px;">
          Current Password:<br>
          <input type="password" id="settings-current-password" name="current_password" style="width:100%;padding:8px;">
        </label>
        <label style="display:block;margin-bottom:12px;">
          New Password:<br>
          <input type="password" id="settings-new-password" name="new_password" style="width:100%;padding:8px;">
        </label>
        <label style="display:block;margin-bottom:24px;">
          Confirm New Password:<br>
          <input type="password" id="settings-confirm-password" name="confirm_password" style="width:100%;padding:8px;">
        </label>
        <button type="button" id="settings-change-password-btn" style="background:#00ff95;color:#191919;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;">Change Password</button>
        <button type="button" id="delete-account-btn" class="delete-account-btn" style="margin:24px auto 0 auto;display:block;background:#fff;color:#c00;border:1.5px solid #c00;border-radius:8px;padding:8px 18px;font-size:0.98em;font-weight:500;cursor:pointer;transition:background 0.18s,color 0.18s,border 0.18s;">Delete Account</button>
      </form>
    </div>
  </section>
</div>

<script>
// Define API_BASE_URL if not already defined
if (typeof API_BASE_URL === 'undefined') {
    var API_BASE_URL = 'https://api.d4rent.ie';
}

// Greia Pro upgrade modal logic
// Membership modal logic
window.openMembershipModal = function() {
  document.getElementById('pro-signup-modal').style.display = 'block';
  var stripeBtn = document.getElementById('pro-stripe-btn');
  if (stripeBtn) {
    stripeBtn.onclick = async function(e) {
      e.preventDefault();
      try {
        const res = await fetch('/api/membership/upgrade', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + (window.token || localStorage.getItem('token') || ''),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ tier: 'Greia Pro' })
        });
        if (!res.ok) throw new Error('Failed to initiate payment');
        const data = await res.json();
        if (data.stripe_url) {
          window.location.href = data.stripe_url;
        } else {
          alert('Payment link unavailable. Please contact support.');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };
  }
}
window.closeMembershipModal = function() {
  document.getElementById('pro-signup-modal').style.display = 'none';
}

// Exposure package modal logic
window.openExposureModal = function(tier) {
  document.getElementById('exposure-modal').style.display = 'block';
  var title = document.querySelector('#exposure-modal h2');
  var content = document.getElementById('exposure-modal-content');
  var stripeBtn = document.getElementById('stripe-btn');
  let details = '';
  let price = '';
  if (tier === 'Silver') {
    title.textContent = 'Purchase Silver Exposure Package';
    details = 'Standard listing exposure. ‚Ç¨100 (or ‚Ç¨50 for Greia Pro members).';
    price = 100;
  } else if (tier === 'Gold') {
    title.textContent = 'Purchase Gold Exposure Package';
    details = 'Featured placement & social media push. ‚Ç¨250 (or ‚Ç¨125 for Greia Pro members).';
    price = 250;
  } else if (tier === 'Platinum') {
    title.textContent = 'Purchase Platinum Exposure Package';
    details = 'Maximum exposure, homepage banner. ‚Ç¨500 (or ‚Ç¨250 for Greia Pro members).';
    price = 500;
  }
  content.textContent = details;

  // Add property/service selection dropdown
  const selectLabel = document.createElement('label');
  selectLabel.textContent = 'Select Property or Service to Promote:';
  selectLabel.style = 'display:block;margin-top:18px;font-weight:500;';
  const select = document.createElement('select');
  select.id = 'exposure-target-select';
  select.style = 'width:100%;margin-top:8px;padding:8px;border-radius:6px;border:1px solid #ccc;';
  select.innerHTML = '<option value="">Loading...</option>';
  content.appendChild(selectLabel);
  content.appendChild(select);

  // Fetch user's properties and services, then populate dropdown
  (async function() {
    let options = '';
    try {
      // Fetch properties
      const propRes = await fetch(`${API_BASE_URL}/api/properties?user=${currentUser?.id || 'me'}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      let properties = propRes.ok ? await propRes.json() : [];
      properties = properties.filter(p => p.user_id == currentUser?.id);
      if (properties.length > 0) {
        options += '<optgroup label="Properties">';
        properties.forEach(p => {
          options += `<option value="property-${p.id}">${p.title || 'Untitled Property'}</option>`;
        });
        options += '</optgroup>';
      }
      // Fetch services
      const servRes = await fetch(`${API_BASE_URL}/api/services?user=${currentUser?.id || 'me'}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      let services = servRes.ok ? await servRes.json() : [];
      services = services.filter(s => s.user_id == currentUser?.id);
      if (services.length > 0) {
        options += '<optgroup label="Services">';
        services.forEach(s => {
          options += `<option value="service-${s.id}">${s.name || 'Untitled Service'}</option>`;
        });
        options += '</optgroup>';
      }
      if (!options) options = '<option value="">No properties or services found</option>';
    } catch (err) {
      options = '<option value="">Error loading options</option>';
    }
    select.innerHTML = options;
  })();

  if (stripeBtn) {
    stripeBtn.onclick = async function(e) {
      e.preventDefault();
      const target = select.value;
      if (!target) {
        alert('Please select a property or service to promote.');
        return;
      }
      try {
        const res = await fetch('/api/exposure/purchase', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + (window.token || localStorage.getItem('token') || ''),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ tier: tier, price: price, target: target })
        });
        if (!res.ok) throw new Error('Failed to initiate payment');
        const data = await res.json();
        if (data.stripe_url) {
          window.location.href = data.stripe_url;
        } else {
          alert('Payment link unavailable. Please contact support.');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };
  }
}
window.closeExposureModal = function() {
  document.getElementById('exposure-modal').style.display = 'none';
}

// Auth check - get user data from API
const token = localStorage.getItem('token');
let currentUser = null;

if (!token) {
  // window.location.href = '/pages/login.html'; // Disabled for testing
}

// Helper function to get profile picture URL
function getProfilePicUrl(profilePicture) {
  if (!profilePicture) return '../assets/blank-profile-picture-973460_960_720.webp';
  if (profilePicture.startsWith('http')) return profilePicture;
  if (profilePicture.startsWith('/uploads/')) return profilePicture;
  return '/uploads/' + profilePicture;
}

// Helper function to get company logo URL
function getCompanyLogoUrl(companyLogo) {
  if (!companyLogo) return '';
  if (companyLogo.startsWith('http')) return companyLogo;
  if (companyLogo.startsWith('/uploads/')) return companyLogo;
  return '/uploads/' + companyLogo;
}

// Fetch and display user profile
async function fetchUserProfile() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        // Token is invalid or expired
        localStorage.removeItem('token');
        window.location.href = '/pages/login.html';
        return;
      }
      throw new Error(`HTTP ${response.status}: Failed to fetch profile`);
    }
    
    const user = await response.json();
    if (user.error || user.message) {
      console.error('Profile fetch error:', user.error || user.message);
      // Still show what we can
      currentUser = user;
      updateProfileDisplay({ full_name: 'Error loading profile', email: user.error || user.message });
      return;
    }
    
    currentUser = user;
    updateProfileDisplay(user);
    updateWelcomeMessage(user);
    updateEditForm(user);
    updateDashboardCards();
    updateAdminNavigation(user);
    
  } catch (error) {
    console.error('Error fetching profile:', error);
    // Show fallback UI
    updateProfileDisplay({ 
      full_name: 'Profile Load Error', 
      email: 'Unable to load profile data',
      company_name: '',
      profession: '',
      phone_number: ''
    });
  }
}

// Update profile display
function updateProfileDisplay(user) {
  // Update profile header
  document.getElementById('profile-fullname-main').textContent = user.full_name || 'No name set';
  document.getElementById('profile-company-main').textContent = user.company_name || user.company || '';
  document.getElementById('profile-profession-main').textContent = user.profession || '';
  document.getElementById('profile-email-main').textContent = user.email || '';
  document.getElementById('profile-phone-main').textContent = user.phone_number || '';
  
  // Update profile picture
  const profilePic = document.getElementById('profile-picture-main');
  if (profilePic) {
    profilePic.src = getProfilePicUrl(user.profile_picture);
    profilePic.alt = user.full_name || 'Profile Picture';
  }
}

// Update welcome message
function updateWelcomeMessage(user) {
  const welcomeName = document.getElementById('profile-welcome-name');
  const welcomeDate = document.getElementById('profile-welcome-date');
  
  if (welcomeName) {
    welcomeName.textContent = user.full_name ? user.full_name.split(' ')[0] : 'User';
  }
  
  if (welcomeDate) {
    const now = new Date();
    welcomeDate.textContent = now.toLocaleDateString('en-IE', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
  }
}

// Update edit form with user data
function updateEditForm(user) {
  document.getElementById('edit-full_name').value = user.full_name || '';
  document.getElementById('edit-email').value = user.email || '';
  document.getElementById('edit-phone_number').value = user.phone_number || '';
  document.getElementById('edit-role').value = user.role || '';
  document.getElementById('edit-company').value = user.company_name || user.company || '';
  document.getElementById('edit-profession').value = user.profession || '';
  document.getElementById('edit-bio').value = user.bio || '';
  document.getElementById('edit-receive_notifications').checked = !!user.receive_notifications;
  document.getElementById('edit-receive_sms').checked = !!user.receive_sms;
}

// Update dashboard cards with real data
function updateDashboardCards() {
  // These could be fetched from API or calculated from user data
  document.getElementById('dashboard-photo-count').textContent = currentUser?.profile_picture ? '1' : '0';
  document.getElementById('dashboard-property-count').textContent = '0'; // This will be updated when properties are fetched
  document.getElementById('dashboard-saved-count').textContent = '0'; // This will be updated when saved items are fetched
}

// Update admin navigation visibility
function updateAdminNavigation(user) {
  const adminDashboardBtn = document.getElementById('nav-admin-dashboard');
  if (adminDashboardBtn) {
    // Show admin dashboard button only for admin users
    if (user.role === 'Admin' || user.role === 'admin') {
      adminDashboardBtn.style.display = 'block';
    } else {
      adminDashboardBtn.style.display = 'none';
    }
  }
}

// Handle profile update
document.getElementById('edit-profile-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
      method: 'PUT',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('Failed to update profile');
    }
    
    const data = await response.json();
    if (data.success) {
      alert('Profile updated successfully!');
      // Refresh profile data
      await fetchUserProfile();
    } else {
      alert(data.error || 'Update failed');
    }
    
  } catch (error) {
    console.error('Error updating profile:', error);
    alert('Error updating profile. Please try again.');
  }
});

// Fetch user's properties/listings
async function fetchUserProperties() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/properties?user=${currentUser?.id || 'me'}`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      let properties = await response.json();
      properties = properties.filter(p => p.user_id == currentUser?.id);
      displayUserProperties(properties);
      document.getElementById('dashboard-property-count').textContent = properties.length;
    } else {
      displayUserProperties([]);
    }
  } catch (error) {
    console.error('Error fetching properties:', error);
    displayUserProperties([]);
  }
}

// Display user properties
function displayUserProperties(properties) {
  const grid = document.getElementById('user-listings-grid');
  if (!grid) return;
  
  if (properties.length === 0) {
    grid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No properties listed yet.</p>';
    return;
  }
  
  grid.innerHTML = properties.map(property => `
    <div class="profile-card">
      <img class="property-card-img" src="${property.image ? (property.image.startsWith('http') ? property.image : '/uploads/' + property.image) : '../assets/sold buy.png'}" alt="${property.title || 'Property'}">
      <div class="property-card-title">${property.title || 'Untitled Property'}</div>
      <div class="property-card-address">${property.address || 'Address not specified'}</div>
      <div class="property-card-price">${property.price || 'Price on request'}</div>
      <div class="property-card-type">${property.type || 'Property'}</div>
      <div style="margin: 8px 0; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; text-transform: uppercase; 
        ${property.approved === 1 ? 'background: #dcfce7; color: #166534;' : 
          property.workflow_status === 'rejected' ? 'background: #fee2e2; color: #dc2626;' : 
          'background: #fef3c7; color: #92400e;'}">
        ${property.approved === 1 ? '‚úÖ Live' : 
          property.workflow_status === 'rejected' ? '‚ùå Rejected' : 
          '‚è≥ Pending Review'}
      </div>
      <div class="profile-card-actions">
        <button class="profile-card-btn" onclick="editProperty(${property.id})">Edit</button>
        <button class="profile-card-btn" onclick="deleteProperty(${property.id})">Delete</button>
        <a href="/pages/propertytemplate.html?id=${property.id}" class="profile-card-btn">View</a>
      </div>
    </div>
  `).join('');
}

// Navigation between sections
document.querySelectorAll('.sidebar-nav button').forEach(btn => {
  btn.addEventListener('click', function() {
    // Handle admin dashboard navigation separately
    if (btn.id === 'nav-admin-dashboard') {
      window.location.href = '/pages/admindashboard.html';
      return;
    }
    // Update active nav button
    document.querySelectorAll('.sidebar-nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Show corresponding section
    const sectionId = 'section-' + btn.id.replace('nav-', '');
    document.querySelectorAll('.profile-section').forEach(sec => {
      sec.style.display = 'none';
      sec.classList.remove('active');
    });
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
      targetSection.style.display = '';
      targetSection.classList.add('active');
      // Load data for specific sections
      if (sectionId === 'section-properties') {
        fetchUserProperties();
      } else if (sectionId === 'section-ads') {
        fetchUserAds();
      } else if (sectionId === 'section-services') {
        fetchUserServices();
      }
    }
  });
});

// Handle logout
document.getElementById('nav-logout').addEventListener('click', function() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('token');
    window.location.href = '/pages/login.html';
  }
});

// Handle account deletion
document.getElementById('delete-account-btn').addEventListener('click', async function() {
  if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
        method: 'DELETE',
        headers: { 
          'Authorization': 'Bearer ' + token 
        }
      });
      
      if (response.ok) {
        alert('Account deleted successfully');
        localStorage.removeItem('token');
        window.location.href = '/pages/register.html';
      } else {
        alert('Error deleting account');
      }
    } catch (error) {
      console.error('Error deleting account:', error);
      alert('Error deleting account');
    }
  }
});

// Property form functions
function showAddServiceForm() {
  // Always allow user to fill out contract and upload form
  document.getElementById('add-service-form').style.display = 'none';
  document.getElementById('edit-service-form').style.display = 'none';
  document.getElementById('service-contract-form').style.display = 'block';
}

// Ensure the contract is hidden by default on page load
document.addEventListener('DOMContentLoaded', function() {
  var contractForm = document.getElementById('service-contract-form');
  if (contractForm) contractForm.style.display = 'none';

  // Stripe payment flow: check for servicePaid=1 in URL
  const params = new URLSearchParams(window.location.search);
  if (params.get('servicePaid') === '1') {
    window.hasPaidForService = true;
    setTimeout(function() {
      alert('Service payment successful! You may now submit your service listing.');
    }, 300);
    // Optionally, remove the param from the URL for cleanliness
    if (window.history.replaceState) {
      const cleanUrl = window.location.pathname + window.location.hash;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  }
});
  document.getElementById('property-upload-form').reset();
  // Reset contract checkboxes
  document.getElementById('property-contract-agree').checked = false;
  document.getElementById('property-ownership-confirm').checked = false;

function showEditPropertyForm(property) {
  console.log('showEditPropertyForm called with:', property);
  
  const editForm = document.getElementById('edit-property-form');
  if (!editForm) {
    console.error('Edit property form not found');
    return;
  }
  
  // Helper function to safely set element value
  function setElementValue(id, value) {
    const element = document.getElementById(id);
    if (element) {
      element.value = value || '';
      console.log(`Set ${id} to:`, value || '');
    } else {
      console.error(`Element with ID '${id}' not found`);
    }
  }
  
  // Show the form first
  editForm.style.display = 'block';
  const addForm = document.getElementById('add-property-form');
  if (addForm) {
    addForm.style.display = 'none';
  }
  
  // Use setTimeout to ensure DOM is ready
  setTimeout(() => {
    setElementValue('edit-property-id', property.id);
    setElementValue('edit-property-title', property.title);
    setElementValue('edit-property-price', property.price);
    setElementValue('edit-property-rent', property.rent_price);
    setElementValue('edit-property-deposit', property.deposit);
    setElementValue('edit-property-type', property.property_type);
    setElementValue('edit-property-status', property.status);
    setElementValue('edit-property-listing-type', property.listing_type);
    setElementValue('edit-property-bedrooms', property.bedrooms);
    setElementValue('edit-property-bathrooms', property.bathrooms);
    setElementValue('edit-property-size', property.size_sqft);
    setElementValue('edit-property-year-built', property.year_built);
    setElementValue('edit-property-address', property.address);
    setElementValue('edit-property-city', property.city);
    setElementValue('edit-property-county', property.county);
    setElementValue('edit-property-eircode', property.eircode);
    setElementValue('edit-property-energy-rating', property.energy_rating);
    setElementValue('edit-property-condition', property.condition);
    setElementValue('edit-property-description', property.description);
    setElementValue('edit-property-heating', property.heating);
    setElementValue('edit-property-parking', property.parking);
    setElementValue('edit-property-garden', property.garden);
    setElementValue('edit-property-furnished', property.furnished);
    setElementValue('edit-property-pets', property.pets_allowed);
    setElementValue('edit-property-smoking', property.smoking_allowed);
    setElementValue('edit-property-available', property.available_from);
    setElementValue('edit-property-lease', property.lease_term);
    
    // Re-initialize auto-save for this form
    initializeAutoSave();
  }, 100);
}

function hideEditPropertyForm() {
  document.getElementById('edit-property-form').style.display = 'none';
  document.getElementById('property-edit-form').reset();
}

// Advertisement form functions
function showAddAdForm() {
  document.getElementById('ad-contract-form').style.display = 'block';
  document.getElementById('add-ad-form').style.display = 'none';
  document.getElementById('edit-ad-form').style.display = 'none';
}

// Add tier selection UI to ad upload form
document.addEventListener('DOMContentLoaded', function() {
  var adForm = document.getElementById('ad-upload-form');
  if (adForm && !document.getElementById('ad-tier-group')) {
    var tierGroup = document.createElement('div');
    tierGroup.id = 'ad-tier-group';
    tierGroup.style.marginBottom = '18px';
    tierGroup.innerHTML = `
      <label style="font-weight:500;display:block;margin-bottom:8px;">Choose Advertisement Tier:</label>
      <div style="display:flex;gap:18px;flex-wrap:wrap;">
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="radio" name="ad_tier" value="basic" required> Basic<br>
          <span style="font-size:0.95em;color:#888;">Standard listing</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="radio" name="ad_tier" value="boosted"> Boosted<br>
          <span style="font-size:0.95em;color:#888;">Extra visibility, featured placement</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="radio" name="ad_tier" value="premium"> Premium<br>
          <span style="font-size:0.95em;color:#888;">Maximum push, homepage & newsletter</span>
        </label>
      </div>
    `;
    adForm.insertBefore(tierGroup, adForm.firstChild);
  }
});

function hideAdContract() {
  document.getElementById('ad-contract-form').style.display = 'none';
}

function proceedToAdForm() {
  const agreeChecked = document.getElementById('ad-contract-agree').checked;
  const legalChecked = document.getElementById('ad-legal-confirm').checked;
  
  if (!agreeChecked || !legalChecked) {
    alert('Please agree to all terms and confirmations before proceeding.');
    return;
  }
  
  document.getElementById('ad-contract-form').style.display = 'none';
  document.getElementById('add-ad-form').style.display = 'block';
}

function hideAddAdForm() {
  document.getElementById('add-ad-form').style.display = 'none';
  document.getElementById('ad-upload-form').reset();
  // Reset contract checkboxes
  document.getElementById('ad-contract-agree').checked = false;
  document.getElementById('ad-legal-confirm').checked = false;
}

function showEditAdForm() {
  document.getElementById('edit-ad-form').style.display = 'block';
  document.getElementById('add-ad-form').style.display = 'none';
  
  // Re-initialize auto-save for this form since it might have been dynamically updated
  setTimeout(() => {
    initializeAutoSave();
  }, 100);
}

function hideEditAdForm() {
  document.getElementById('edit-ad-form').style.display = 'none';
  document.getElementById('ad-edit-form').reset();
}

// Service form functions
async function payForServiceListing() {
  try {
    // Initiate payment for service listing BEFORE service creation
    const res = await fetch(`${API_BASE_URL}/api/services/pay`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ user_id: currentUser?.id })
    });
    if (!res.ok) {
      let msg = 'Payment initiation failed.';
      if (res.status === 403) msg = 'You are not authorized to pay for this service.';
      alert(msg);
      return;
    }
    const data = await res.json();
    if (data.stripe_url) {
      // Set a flag after payment (should be set after redirect/callback in production)
      window.hasPaidForService = true;
      window.location.href = data.stripe_url;
    } else {
      alert('Payment link unavailable. Please contact support.');
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

function showAddServiceForm() {
  if (!window.hasPaidForService) {
    if (confirm('You must pay the service listing fee before submitting. Proceed to payment?')) {
      payForServiceListing();
    }
    return;
  }
  document.getElementById('service-contract-form').style.display = 'block';
  document.getElementById('add-service-form').style.display = 'none';
  document.getElementById('edit-service-form').style.display = 'none';
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'service-stripe-btn';
      btn.textContent = 'Pay with Stripe';
      btn.style = 'margin-top:24px;padding:12px 28px;background:#635bff;color:#fff;border:none;border-radius:8px;font-size:1.1em;cursor:pointer;';
      btn.onclick = async function() {
        btn.disabled = true;
        btn.textContent = 'Redirecting...';
        try {
          // Call backend to create Stripe Checkout session
          const res = await fetch(`${API_BASE_URL}/api/services/pay`, {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: currentUser?.id })
          });
          if (!res.ok) throw new Error('Failed to create payment session');
          const data = await res.json();
          if (data.stripe_url) {
            window.location.href = data.stripe_url;
          } else {
            alert('Payment error: No Stripe URL returned');
            btn.disabled = false;
            btn.textContent = 'Pay with Stripe';
          }
        } catch (err) {
          alert('Payment error: ' + err.message);
          btn.disabled = false;
          btn.textContent = 'Pay with Stripe';
        }
      };
      modal.querySelector('div').appendChild(btn);
    }
    return;
  }
  document.getElementById('service-contract-form').style.display = 'block';
  document.getElementById('add-service-form').style.display = 'none';
  document.getElementById('edit-service-form').style.display = 'none';

window.hasPaidForService = false; // Set to true after payment

function closeServicePaywallModal() {
  document.getElementById('service-paywall-modal').style.display = 'none';
}


function hideServiceContract() {
  document.getElementById('service-contract-form').style.display = 'none';
}

function proceedToServiceForm() {
  const agreeChecked = document.getElementById('service-contract-agree').checked;
  const licenseChecked = document.getElementById('service-license-confirm').checked;
  const insuranceChecked = document.getElementById('service-insurance-confirm').checked;
  
  if (!agreeChecked || !licenseChecked || !insuranceChecked) {
    alert('Please agree to all terms and confirmations before proceeding.');
    return;
  }
  
  document.getElementById('service-contract-form').style.display = 'none';
  document.getElementById('add-service-form').style.display = 'block';
}

function hideAddServiceForm() {
  document.getElementById('add-service-form').style.display = 'none';
  document.getElementById('service-upload-form').reset();
  // Reset contract checkboxes
  document.getElementById('service-contract-agree').checked = false;
  document.getElementById('service-license-confirm').checked = false;
  document.getElementById('service-insurance-confirm').checked = false;
}

function showEditServiceForm(service) {
  const editForm = document.getElementById('edit-service-form');
  document.getElementById('edit-service-id').value = service.id;
  document.getElementById('edit-service-name').value = service.name || '';
  document.getElementById('edit-service-category').value = service.category || '';
  document.getElementById('edit-service-type').value = service.service_type || '';
  document.getElementById('edit-service-price-structure').value = service.price_structure || '';
  document.getElementById('edit-service-price').value = service.price_range || '';
  document.getElementById('edit-service-availability').value = service.availability || '';
  document.getElementById('edit-service-response-time').value = service.response_time || '';
  document.getElementById('edit-service-description').value = service.description || '';
  document.getElementById('edit-service-areas').value = service.service_areas || '';
  document.getElementById('edit-service-website').value = service.website || '';
  document.getElementById('edit-service-phone').value = service.phone || '';
  document.getElementById('edit-service-email').value = service.email || '';
  document.getElementById('edit-service-certifications').value = service.certifications || '';
  document.getElementById('edit-service-insurance').value = service.insurance || '';
  document.getElementById('edit-service-experience').value = service.experience_years || '';
  editForm.style.display = 'block';
  document.getElementById('add-service-form').style.display = 'none';
  
  // Re-initialize auto-save for this form
  setTimeout(() => {
    initializeAutoSave();
  }, 100);
}

function hideEditServiceForm() {
  document.getElementById('edit-service-form').style.display = 'none';
  document.getElementById('service-edit-form').reset();
}

// Handle property upload
document.getElementById('property-upload-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  // Ensure property starts in pending approval status
  formData.append('approved', '0');
  formData.append('workflow_status', 'pending');
  
  // Log form data for debugging
  console.log('Submitting property with data:');
  for (let [key, value] of formData.entries()) {
    console.log(`${key}:`, value);
  }
  
  try {
    console.log('Making request to:', `${API_BASE_URL}/api/properties`);
    const response = await fetch(`${API_BASE_URL}/api/properties`, {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', response.headers);
    
    if (!response.ok) {
      // Try to get detailed error information
      let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
      let errorDetails = '';
      
      try {
        const errorData = await response.json();
        if (errorData.error) errorDetails = errorData.error;
        if (errorData.message) errorDetails = errorData.message;
        if (errorData.details) errorDetails += ' - ' + errorData.details;
      } catch (parseError) {
        // If JSON parsing fails, try to get text
        try {
          errorDetails = await response.text();
        } catch (textError) {
          errorDetails = 'Unable to parse error response';
        }
      }
      
      console.error('Server error details:', errorDetails);
      throw new Error(`${errorMessage}${errorDetails ? ': ' + errorDetails : ''}`);
    }
    
    const data = await response.json();
    console.log('Property created successfully:', data);
    alert('Property submitted successfully! It will be reviewed by our team and published once approved. You will be notified of the status.');
    
    // Hide form and refresh properties
    hideAddPropertyForm();
    fetchUserProperties();
    
  } catch (error) {
    console.error('Error adding property:', error);
    
    // Show more detailed error message to user
    let userMessage = 'Error adding property. ';
    if (error.message.includes('500')) {
      userMessage += 'The server is experiencing technical difficulties. Please try again later or contact support.';
    } else if (error.message.includes('401')) {
      userMessage += 'Authentication failed. Please log in again.';
      localStorage.removeItem('token');
      window.location.href = '/pages/login.html';
      return;
    } else if (error.message.includes('403')) {
      userMessage += 'You do not have permission to add properties.';
    } else if (error.message.includes('network') || error.name === 'TypeError') {
      userMessage += 'Network connection failed. Please check your internet connection.';
    } else {
      userMessage += 'Please try again or contact support if the problem persists.';
    }
    
    alert(userMessage);
    console.log('Full error object:', error);
  }
});

// Handle property edit
document.getElementById('property-edit-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const propertyId = document.getElementById('edit-property-id').value;
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/properties/${propertyId}`, {
      method: 'PUT',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('Failed to update property');
    }
    
    const data = await response.json();
    alert('Property updated successfully!');
    
    // Hide form and refresh properties
    hideEditPropertyForm();
    fetchUserProperties();
    
  } catch (error) {
    console.error('Error updating property:', error);
    alert('Error updating property. Please try again.');
  }
});

// Handle advertisement upload
document.getElementById('ad-upload-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  // Add required status field to match database schema
  formData.append('status', 'pending');
  formData.append('approved', '0');
  
  // Debug: Log the form data being sent
  console.log('Advertisement form data being sent:');
  for (let [key, value] of formData.entries()) {
    console.log(`${key}:`, value);
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/advertisements`, {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      console.error('Advertisement submission failed:', response.status, response.statusText);
      
      // Try to get detailed error message
      let errorMessage = 'Failed to add advertisement';
      try {
        const errorData = await response.text();
        console.error('Server response:', errorData);
        
        // Try to parse as JSON for structured error
        try {
          const jsonError = JSON.parse(errorData);
          errorMessage = jsonError.message || jsonError.error || errorMessage;
        } catch (e) {
          // If not JSON, use the text response
          errorMessage = errorData || errorMessage;
        }
      } catch (e) {
        console.error('Could not read error response:', e);
      }
      
      throw new Error(errorMessage);
    }
    
    const data = await response.json();
    alert('Advertisement submitted successfully! It will be reviewed by our team and published once approved. You will be notified of the status.');
    
    // Hide form and refresh ads
    hideAddAdForm();
    fetchUserAds();
    
  } catch (error) {
    console.error('Error adding advertisement:', error);
    alert(`Error adding advertisement: ${error.message}. Please check the console for more details.`);
  }
});

// Handle advertisement edit
document.getElementById('ad-edit-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  console.log('Ad edit form submitted');
  const formData = new FormData(this);
  const adId = document.getElementById('edit-ad-id').value;
  
  console.log('Editing advertisement ID:', adId);
  console.log('Form data entries:');
  for (let [key, value] of formData.entries()) {
    console.log(key + ':', value);
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/advertisements/${adId}`, {
      method: 'PUT',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Response error:', errorText);
      throw new Error(`Failed to update advertisement: ${response.status} ${errorText}`);
    }
    
    const data = await response.json();
    console.log('Update successful:', data);
    alert('Advertisement updated successfully!');
    
    // Hide form and refresh ads
    hideEditAdForm();
    fetchUserAds();
    
  } catch (error) {
    console.error('Error updating advertisement:', error);
    alert('Error updating advertisement: ' + error.message);
  }
});

// Handle service upload
document.getElementById('service-upload-form').addEventListener('submit', async function(e) {
  // Enforce payment before final submission
  if (!window.hasPaidForService) {
    e.preventDefault();
    if (confirm('You must pay the service listing fee before submitting. Proceed to payment?')) {
      payForServiceListing();
    }
    return;
  }
  e.preventDefault();
  
  const formData = new FormData(this);
  
  // Add required status field to match database schema
  formData.append('status', 'pending');
  formData.append('approved', '0');
  
  // Debug: Log the form data being sent
  console.log('Service form data being sent:');
  for (let [key, value] of formData.entries()) {
    console.log(`${key}:`, value);
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/services`, {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    if (!response.ok) {
      // ...existing error handling code...
      let errorMessage = 'Failed to add service';
      try {
        const errorData = await response.text();
        console.error('Server response:', errorData);
        try {
          const jsonError = JSON.parse(errorData);
          errorMessage = jsonError.message || jsonError.error || errorMessage;
        } catch (e) {
          errorMessage = errorData || errorMessage;
        }
      } catch (e) {
        console.error('Could not read error response:', e);
      }
      throw new Error(errorMessage);
    }
    const data = await response.json();
    if (data && data.id) {
      // Initiate payment for the newly created service
      try {
        const payRes = await fetch(`${API_BASE_URL}/api/services/${data.id}/pay`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        if (!payRes.ok) {
          let payMsg = 'Payment initiation failed.';
          if (payRes.status === 403) payMsg = 'You are not authorized to pay for this service.';
          alert(payMsg);
        } else {
          const payData = await payRes.json();
          if (payData.url) {
            window.location.href = payData.url; // Redirect to Stripe Checkout
          } else {
            alert('Payment link unavailable. Please contact support.');
          }
        }
      } catch (err) {
        alert('Error initiating payment: ' + err.message);
      }
    } else {
      alert('Service submitted, but no ID returned. Cannot initiate payment.');
    }
    // Hide form and refresh services
    hideAddServiceForm();
    fetchUserServices();
  } catch (error) {
    console.error('Error adding service:', error);
    alert(`Error adding service: ${error.message}. Please check the console for more details.`);
  }
});

// Handle service edit
document.getElementById('service-edit-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const serviceId = document.getElementById('edit-service-id').value;
  
  // Debug: Log the form data being sent
  console.log('Service edit form data being sent:');
  for (let [key, value] of formData.entries()) {
    console.log(`${key}:`, value);
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/services/${serviceId}`, {
      method: 'PUT',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      console.error('Service edit failed:', response.status, response.statusText);
      
      // Try to get detailed error message
      let errorMessage = 'Failed to update service';
      try {
        const errorData = await response.text();
        console.error('Server response:', errorData);
        
        // Try to parse as JSON for structured error
        try {
          const jsonError = JSON.parse(errorData);
          errorMessage = jsonError.message || jsonError.error || errorMessage;
        } catch (e) {
          // If not JSON, use the text response
          errorMessage = errorData || errorMessage;
        }
      } catch (e) {
        console.error('Could not read error response:', e);
      }
      
      throw new Error(errorMessage);
    }
    
    const data = await response.json();
    alert('Service updated successfully!');
    
    // Hide form and refresh services
    hideEditServiceForm();
    fetchUserServices();
    
  } catch (error) {
    console.error('Error updating service:', error);
    alert(`Error updating service: ${error.message}. Please check the console for more details.`);
  }
});

// Property management functions
// Show the property contract agreement (Step 1)
function showAddPropertyForm() {
  document.getElementById('property-contract-form').style.display = 'block';
  document.getElementById('add-property-form').style.display = 'none';
}

// Proceed to the actual property form (Step 2)
function proceedToPropertyForm() {
  // Ensure checkboxes are checked
  const agree = document.getElementById('property-contract-agree').checked;
  const owner = document.getElementById('property-ownership-confirm').checked;
  if (!agree || !owner) {
    alert('You must agree to the terms and confirm ownership to continue.');
    return;
  }
  document.getElementById('property-contract-form').style.display = 'none';
  document.getElementById('add-property-form').style.display = 'block';
}

// Hide the property contract agreement (cancel)
function hidePropertyContract() {
  document.getElementById('property-contract-form').style.display = 'none';
}

// Hide the add property form (cancel)
function hideAddPropertyForm() {
  document.getElementById('add-property-form').style.display = 'none';
}
function editProperty(propertyId) {
  console.log('Editing property with ID:', propertyId);
  // Find the property data and populate the edit form
  fetchPropertyData(propertyId).then(property => {
    if (property) {
      console.log('Property data received:', property);
      showEditPropertyForm(property);
    } else {
      console.error('No property data received for ID:', propertyId);
      alert('Error: Could not load property data');
    }
  }).catch(error => {
    console.error('Error in editProperty:', error);
    alert('Error loading property data');
  });
}

async function fetchPropertyData(propertyId) {
  try {
    console.log('Fetching property data for ID:', propertyId);
    const response = await fetch(`${API_BASE_URL}/api/properties/${propertyId}`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('Property fetch response status:', response.status);
    
    if (response.ok) {
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const property = await response.json();
        console.log('Property data fetched successfully:', property);
        return property;
      } else {
        const text = await response.text();
        console.error('Non-JSON response:', text);
        alert('Unexpected server response. Please try again or contact support.');
      }
    } else {
      console.error('Failed to fetch property data, status:', response.status);
      const errorText = await response.text();
      console.error('Error response:', errorText);
    }
  } catch (error) {
    console.error('Error fetching property data:', error);
  }
  return null;
}

async function deleteProperty(propertyId) {
  if (confirm('Are you sure you want to delete this property?')) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/properties/${propertyId}`, {
        method: 'DELETE',
        headers: { 
          'Authorization': 'Bearer ' + token 
        }
      });
      
      if (response.ok) {
        alert('Property deleted successfully');
        fetchUserProperties(); // Refresh the list
      } else {
        alert('Error deleting property');
      }
    } catch (error) {
      console.error('Error deleting property:', error);
      alert('Error deleting property');
    }
  }
}

// Fetch user's advertisements
async function fetchUserAds() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/advertisements?user=${currentUser?.id || 'me'}`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        let ads = await response.json();
        ads = ads.filter(a => a.user_id == currentUser?.id);
        displayUserAds(ads);
      } else {
        const text = await response.text();
        console.error('Non-JSON response:', text);
        alert('Unexpected server response. Please try again or contact support.');
        displayUserAds([]);
      }
    } else {
      displayUserAds([]);
    }
  } catch (error) {
    console.error('Error fetching advertisements:', error);
    displayUserAds([]);
  }
}

// Display user advertisements
function displayUserAds(ads) {
  const grid = document.getElementById('user-advertisements-grid');
  if (!grid) return;

  if (ads.length === 0) {
    grid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No advertisements yet.</p>';
    return;
  }

  grid.innerHTML = ads.map(ad => `
    <div class="profile-card">
      <img class="profile-card-img" src="${ad.image ? (ad.image.startsWith('http') ? ad.image : '/uploads/' + ad.image) : '../assets/creative.png'}" alt="${ad.title || 'Advertisement'}">
      <div class="profile-card-title">${ad.title || 'Untitled Advertisement'}</div>
      <div class="profile-card-detail">${ad.category || 'Category not specified'}</div>
      <div class="profile-card-detail">${ad.price || 'Price on request'}</div>
      <div class="profile-card-detail">${ad.location || 'Location not specified'}</div>
      <div style="margin: 8px 0; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; text-transform: uppercase; 
        ${ad.approved === 1 ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
        ${ad.approved === 1 ? '‚úÖ Live' : ''}
      </div>
      <div class="profile-card-actions">
        <button class="profile-card-btn edit-ad-btn" data-ad-id="${ad.id}">Edit</button>
        <button class="profile-card-btn" onclick="deleteAdvertisement(${ad.id})">Delete</button>
        <a href="/pages/advertisement.html?id=${ad.id}" class="profile-card-btn">View</a>
      </div>
    </div>
  `).join('');

  // Attach event listeners for edit buttons
  grid.querySelectorAll('.edit-ad-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const adId = this.getAttribute('data-ad-id');
      editAdvertisement(adId);
    });
  });
}

// Advertisement management functions
function editAdvertisement(adId) {
  fetchAdData(adId).then(ad => {
    if (ad) {
      document.getElementById('edit-ad-id').value = ad.id;
      setElementValue('edit-ad-title', ad.title);
      setElementValue('edit-ad-category', ad.category);
      setElementValue('edit-ad-sub-category', ad.sub_category);
      setElementValue('edit-ad-target-audience', ad.target_audience);
      setElementValue('edit-ad-price', ad.price);
      setElementValue('edit-ad-currency', ad.currency);
      setElementValue('edit-ad-contact', ad.contact_method);
      setElementValue('edit-ad-phone-number', ad.phone_number);
      setElementValue('edit-ad-email', ad.email);
      setElementValue('edit-ad-link', ad.link);
      setElementValue('edit-ad-bio', ad.bio);
      setElementValue('edit-ad-address', ad.address);
      setElementValue('edit-ad-target-location', ad.target_location);
      setElementValue('edit-ad-service-radius', ad.service_radius);
      setElementValue('edit-ad-business-hours', ad.business_hours);
      setElementValue('edit-ad-response-time', ad.response_time);
      setElementValue('edit-ad-years-business', ad.years_in_business);
      setElementValue('edit-ad-license', ad.license_number);
      setElementValue('edit-ad-insurance', ad.insurance_status);
      setElementValue('edit-ad-emergency', ad.emergency_service);
      showEditAdForm();
    }
  });
}

async function fetchAdData(adId) {
  console.log('Fetching advertisement data for ID:', adId);
  try {
    const response = await fetch(`${API_BASE_URL}/api/advertisements/${adId}`, {
      headers: { 
        'Authorization': 'Bearer ' + token 
      }
    });
    
    console.log('Fetch response status:', response.status);
    
    if (response.ok) {
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const data = await response.json();
        console.log('Advertisement data retrieved:', data);
        return data;
      } else {
        const text = await response.text();
        console.error('Non-JSON response:', text);
        alert('Unexpected server response. Please try again or contact support.');
      }
    } else {
      const errorText = await response.text();
      console.error('Failed to fetch advertisement:', response.status, errorText);
    }
  } catch (error) {
    console.error('Error fetching advertisement data:', error);
  }
  return null;
}

async function deleteAdvertisement(adId) {
  if (confirm('Are you sure you want to delete this advertisement?')) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/advertisements/${adId}`, {
        method: 'DELETE',
        headers: { 
          'Authorization': 'Bearer ' + token 
        }
      });
      
      if (response.ok) {
        alert('Advertisement deleted successfully');
        fetchUserAds();
      } else {
        alert('Error deleting advertisement');
      }
    } catch (error) {
      console.error('Error deleting advertisement:', error);
      alert('Error deleting advertisement');
    }
  }
}

// Fetch user's services
async function fetchUserServices() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/services?user=${currentUser?.id || 'me'}`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        let services = await response.json();
        services = services.filter(s => s.user_id == currentUser?.id);
        displayUserServices(services);
      } else {
        const text = await response.text();
        console.error('Non-JSON response:', text);
        alert('Unexpected server response. Please try again or contact support.');
        displayUserServices([]);
      }
    } else {
      displayUserServices([]);
    }
  } catch (error) {
    console.error('Error fetching services:', error);
    displayUserServices([]);
  }
}

// Display user services
function displayUserServices(services) {
  const grid = document.getElementById('user-services-grid');
  if (!grid) return;
  
  if (services.length === 0) {
    grid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No services yet.</p>';
    return;
  }
  
  const S3_BASE_URL = 'http://d4rent.ie.s3-website-eu-west-1.amazonaws.com/';
  grid.innerHTML = services.map(service => {
    const title = service.title || service.name || '';
    const photoUrl = service.photo
      ? (service.photo.startsWith('http')
          ? service.photo
          : S3_BASE_URL + (service.photo.startsWith('uploads/') ? service.photo : 'uploads/' + service.photo))
      : '../assets/home services.png';
    return `
      <div class="profile-card">
        <img class="profile-card-img" src="${photoUrl}" alt="${title}">
        <div class="profile-card-title">${title || 'Untitled Service'}</div>
        <div class="profile-card-detail">${service.type || 'Service type not specified'}</div>
        <div class="profile-card-detail">${service.price_range || 'Price on request'}</div>
        <div class="profile-card-detail">${service.availability || 'Availability not specified'}</div>
        <div style="margin: 8px 0; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; text-transform: uppercase; 
          ${service.approved === 1 ? 'background: #dcfce7; color: #166534;' : 
            service.rejected_at ? 'background: #fee2e2; color: #dc2626;' : 
            'background: #fef3c7; color: #92400e;'}">
          ${service.approved === 1 ? '‚úÖ Live' : 
            service.rejected_at ? '‚ùå Rejected' : 
            '‚è≥ Pending Review'}
        </div>
        <div class="profile-card-actions">
          <button class="profile-card-btn" onclick="editService(${service.id})">Edit</button>
          <button class="profile-card-btn" onclick="deleteService(${service.id})">Delete</button>
          <a href="/pages/service.html?id=${service.id}" class="profile-card-btn">View</a>
        </div>
      </div>
    `;
  }).join('');
}

// Service management functions
function editService(serviceId) {
  fetchServiceData(serviceId).then(service => {
    if (service) {
      showEditServiceForm(service);
    }
  });
}

async function fetchServiceData(serviceId) {
  try {
    const response = await fetch(`${API_BASE_URL}/api/services/${serviceId}`, {
      headers: { 
        'Authorization': 'Bearer ' + token 
      }
    });
    
    if (response.ok) {
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        return await response.json();
      } else {
        const text = await response.text();
        console.error('Non-JSON response:', text);
        alert('Unexpected server response. Please try again or contact support.');
      }
    }
  } catch (error) {
    console.error('Error fetching service data:', error);
  }
  return null;
}

async function deleteService(serviceId) {
  if (confirm('Are you sure you want to delete this service?')) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/services/${serviceId}`, {
        method: 'DELETE',
        headers: { 
          'Authorization': 'Bearer ' + token 
        }
      });
      
      if (response.ok) {
        alert('Service deleted successfully');
        fetchUserServices();
      } else {
        alert('Error deleting service');
      }
    } catch (error) {
      console.error('Error deleting service:', error);
      alert('Error deleting service');
    }
  }
}

// Check API connectivity by trying to fetch user profile
async function checkAPIConnectivity() {
  try {
    console.log('Testing API connectivity...');
    const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (response.ok || response.status === 401) {
      // 200 = success, 401 = unauthorized but server is responding
      console.log('‚úÖ API server is responding');
      return true;
    } else {
      console.warn('‚ö†Ô∏è API server responded with status:', response.status);
      return false;
    }
  } catch (error) {
    console.error('‚ùå API server connection error:', error.message);
    return false;
  }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Profile page loaded');
  console.log('üì° API_BASE_URL:', API_BASE_URL);
  console.log('üîê Token exists:', !!token);
  console.log('üåê Current URL:', window.location.href);
  
  // Check API connectivity and proceed with profile loading
  checkAPIConnectivity().then(isConnected => {
    if (!isConnected) {
      console.warn('‚ö†Ô∏è API connectivity issues detected');
      // Show user-friendly message but still try to load profile
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; margin: 20px; border-radius: 8px; text-align: center;';
      alertDiv.innerHTML = '‚ö†Ô∏è Connection issues detected. Some features may not work properly.';
      document.querySelector('.profile-content-card').prepend(alertDiv);
    }
    fetchUserProfile();
  });

  // Add settings form submit handler for contact visibility
  const settingsForm = document.getElementById('settings-form');
  if (settingsForm) {
    settingsForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const showEmail = document.getElementById('show-email-checkbox').checked;
      const showPhone = document.getElementById('show-phone-checkbox').checked;
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/contact-visibility`, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ show_email: showEmail, show_phone: showPhone })
        });
        if (response.ok) {
          alert('Contact visibility updated!');
        } else {
          alert('Failed to update contact visibility.');
        }
      } catch (error) {
        alert('Error updating contact visibility.');
      }
    });
  }
});
</script>

<script src="../js/global-nav.js"></script>
<script src="../js/global-search.js"></script>
<script>
function loadProfileSection(section) {
  let url = '';
  switch (section) {
    case 'settings':
      url = 'profile-settings.html';
      break;
    // Add more cases for other sections (properties, ads, etc.)
    default:
      url = '';
  }
  if (!url) return;
  const container = document.getElementById('profile-section-container');
  if (!container) return;
  container.innerHTML = '<div style="text-align:center;padding:32px;">Loading...</div>';
  fetch(url)
    .then(response => response.text())
    .then(html => {
      container.innerHTML = html;
    })
    .catch(() => {
      container.innerHTML = '<div style="color:#c00;text-align:center;padding:32px;">Failed to load section.</div>';
    });
}
</script>
<script>
// Initialize global navigation
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initializeGlobalNavigation === 'function') {
        initializeGlobalNavigation();
    }
    if (typeof initializeGlobalSearch === 'function') {
        initializeGlobalSearch();
    }
    
    // Initialize auto-save for individual field changes
    initializeAutoSave();
});

// Auto-save functionality for individual field changes
function initializeAutoSave() {
  console.log('Initializing auto-save functionality');
  
  // Auto-save for advertisement edit form
  const adEditForm = document.getElementById('ad-edit-form');
  if (adEditForm) {
    console.log('Setting up auto-save for advertisement form');
    const adFields = adEditForm.querySelectorAll('input:not([type="file"]):not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea');
    console.log(`Found ${adFields.length} advertisement fields for auto-save`);
    
    adFields.forEach((field, index) => {
      if (field && field.name && field.id) {
        field.classList.add('auto-save-enabled');
        field.addEventListener('change', debounce(function() {
          // Only trigger auto-save if the form is visible
          const form = document.getElementById('edit-ad-form');
          if (form && form.style.display !== 'none' && this.name && this.value !== undefined) {
            autoSaveAdvertisementField(this);
          }
        }, 1000));
        
        // Add tooltip
        field.title = 'Changes are automatically saved';
        console.log(`Auto-save enabled for ad field: ${field.name}`);
      } else {
        console.warn(`Advertisement field ${index} is missing name/id attribute or is null:`, field);
      }
    });
  } else {
    console.log('Advertisement edit form not found');
  }

  // Auto-save for property edit form
  const propertyEditForm = document.getElementById('property-edit-form');
  if (propertyEditForm) {
    console.log('Setting up auto-save for property form');
    const propertyFields = propertyEditForm.querySelectorAll('input:not([type="file"]):not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea');
    console.log(`Found ${propertyFields.length} property fields for auto-save`);
    
    propertyFields.forEach((field, index) => {
      if (field && field.name && field.id) {
        field.classList.add('auto-save-enabled');
        
        // Add debounced change listener
        field.addEventListener('change', debounce(function() {
          // Only trigger auto-save if the form is visible and field has a value
          const form = document.getElementById('edit-property-form');
          if (form && form.style.display !== 'none' && this.name && this.value !== undefined) {
            console.log(`Property field changed: ${this.name} = ${this.value}`);
            autoSavePropertyField(this);
          }
        }, 1000));
        
        // Add tooltip
        field.title = 'Changes are automatically saved';
        console.log(`Auto-save enabled for property field: ${field.name} (${field.tagName})`);
      } else {
        console.warn(`Property field ${index} is missing name/id attribute or is null:`, field);
      }
    });
  } else {
    console.log('Property edit form not found');
  }

  // Auto-save for service edit form
  const serviceEditForm = document.getElementById('service-edit-form');
  if (serviceEditForm) {
    console.log('Setting up auto-save for service form');
    const serviceFields = serviceEditForm.querySelectorAll('input:not([type="file"]):not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea');
    console.log(`Found ${serviceFields.length} service fields for auto-save`);
    
    serviceFields.forEach((field, index) => {
      if (field && field.name && field.id) {
        field.classList.add('auto-save-enabled');
        field.addEventListener('change', debounce(function() {
          // Only trigger auto-save if the form is visible
          const form = document.getElementById('edit-service-form');
          if (form && form.style.display !== 'none' && this.name && this.value !== undefined) {
            autoSaveServiceField(this);
          }
        }, 1000));
        
        // Add tooltip
        field.title = 'Changes are automatically saved';
        console.log(`Auto-save enabled for service field: ${field.name}`);
      } else {
        console.warn(`Service field ${index} is missing name/id attribute or is null:`, field);
      }
    });
  } else {
    console.log('Service edit form not found');
  }
  
  console.log('Auto-save initialization completed');
}

// Debounce function to prevent too many API calls
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Auto-save individual advertisement field
async function autoSaveAdvertisementField(field) {
  if (!field) {
    console.warn('autoSaveAdvertisementField: field is null');
    return;
  }
  
  const adId = document.getElementById('edit-ad-id')?.value;
  if (!adId) {
    console.warn('autoSaveAdvertisementField: no advertisement ID found');
    return;
  }

  const fieldName = field.name;
  const fieldValue = field.value;

  // Additional validation
  if (!fieldName) {
    console.warn('autoSaveAdvertisementField: field name is empty');
    return;
  }

  if (fieldValue === undefined || fieldValue === null) {
    console.warn(`autoSaveAdvertisementField: field ${fieldName} has undefined/null value`);
    return;
  }

  console.log(`Auto-saving advertisement field: ${fieldName} = ${fieldValue}`);

  // Show saving indicator
  showSavingIndicator(field);

  try {
    // For now, we'll simulate the API call since the backend might not have the individual field update endpoint
    // In a real implementation, you'd make this API call:
    /*
    const formData = new FormData();
    formData.append(fieldName, fieldValue);

    const response = await fetch(`${API_BASE_URL}/api/advertisements/${adId}/field`, {
      method: 'PATCH',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}`);
    }
    */

    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // For now, we'll assume success and show the saved indicator
    showSavedIndicator(field);
    console.log(`Advertisement field ${fieldName} saved successfully`);
    
    // Note: You'll need to implement the backend endpoint /api/advertisements/{id}/field
    // that accepts PATCH requests for individual field updates
    
  } catch (error) {
    console.error('Error auto-saving advertisement field:', error);
    showErrorIndicator(field);
  }
}

// Auto-save individual property field
async function autoSavePropertyField(field) {
  if (!field) {
    console.warn('autoSavePropertyField: field is null');
    return;
  }
  
  const propertyId = document.getElementById('edit-property-id')?.value;
  if (!propertyId) {
    console.warn('autoSavePropertyField: no property ID found');
    return;
  }

  const fieldName = field.name;
  const fieldValue = field.value;

  // Additional validation
  if (!fieldName) {
    console.warn('autoSavePropertyField: field name is empty');
    return;
  }

  if (fieldValue === undefined || fieldValue === null) {
    console.warn(`autoSavePropertyField: field ${fieldName} has undefined/null value`);
    return;
  }

  console.log(`Auto-saving property field: ${fieldName} = ${fieldValue}`);

  // Show saving indicator
  showSavingIndicator(field);

  try {
    // For now, we'll simulate the API call since the backend might not have the individual field update endpoint
    // In a real implementation, you'd make this API call:
    /*
    const formData = new FormData();
    formData.append(fieldName, fieldValue);

    const response = await fetch(`${API_BASE_URL}/api/properties/${propertyId}/field`, {
      method: 'PATCH',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}`);
    }
    */

    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // For now, we'll assume success and show the saved indicator
    showSavedIndicator(field);
    console.log(`Property field ${fieldName} saved successfully`);
    
    // Note: You'll need to implement the backend endpoint /api/properties/{id}/field
    // that accepts PATCH requests for individual field updates
    
  } catch (error) {
    console.error('Error auto-saving property field:', error);
    showErrorIndicator(field);
  }
}

// Auto-save individual service field
async function autoSaveServiceField(field) {
  if (!field) {
    console.warn('autoSaveServiceField: field is null');
    return;
  }
  
  const serviceId = document.getElementById('edit-service-id')?.value;
  if (!serviceId) {
    console.warn('autoSaveServiceField: no service ID found');
    return;
  }

  const fieldName = field.name;
  const fieldValue = field.value;

  // Additional validation
  if (!fieldName) {
    console.warn('autoSaveServiceField: field name is empty');
    return;
  }

  if (fieldValue === undefined || fieldValue === null) {
    console.warn(`autoSaveServiceField: field ${fieldName} has undefined/null value`);
    return;
  }

  console.log(`Auto-saving service field: ${fieldName} = ${fieldValue}`);

  // Show saving indicator
  showSavingIndicator(field);

  try {
    // For now, we'll simulate the API call since the backend might not have the individual field update endpoint
    // In a real implementation, you'd make this API call:
    /*
    const formData = new FormData();
    formData.append(fieldName, fieldValue);

    const response = await fetch(`${API_BASE_URL}/api/services/${serviceId}/field`, {
      method: 'PATCH',
      headers: { 
        'Authorization': 'Bearer ' + token 
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}`);
    }
    */

    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // For now, we'll assume success and show the saved indicator
    showSavedIndicator(field);
    console.log(`Service field ${fieldName} saved successfully`);
    
    // Note: You'll need to implement the backend endpoint /api/services/{id}/field
    // that accepts PATCH requests for individual field updates
    
  } catch (error) {
    console.error('Error auto-saving service field:', error);
    showErrorIndicator(field);
  }
}

// Visual indicators for save status
function showSavingIndicator(field) {
  if (!field) {
    console.warn('Cannot show saving indicator: field is null');
    return;
  }
  
  // Try to find a suitable parent element
  let parentElement = field.parentNode;
  if (!parentElement) {
    console.warn('Cannot show saving indicator: field has no parentNode');
    return;
  }
  
  // If parent is a label, try to find the container
  if (parentElement.tagName === 'LABEL') {
    parentElement = parentElement.parentNode;
  }
  
  if (!parentElement) {
    console.warn('Cannot show saving indicator: no suitable parent found');
    return;
  }
  
  removeSaveIndicators(field);
  const indicator = document.createElement('span');
  indicator.className = 'save-indicator saving';
  indicator.innerHTML = 'üíæ Saving...';
  indicator.style.cssText = 'margin-left: 8px; color: #666; font-size: 12px; display: inline-block;';
  
  // Insert after the field
  if (field.nextSibling) {
    parentElement.insertBefore(indicator, field.nextSibling);
  } else {
    parentElement.appendChild(indicator);
  }
}

function showSavedIndicator(field) {
  if (!field) {
    console.warn('Cannot show saved indicator: field is null');
    return;
  }
  
  // Try to find a suitable parent element
  let parentElement = field.parentNode;
  if (!parentElement) {
    console.warn('Cannot show saved indicator: field has no parentNode');
    return;
  }
  
  // If parent is a label, try to find the container
  if (parentElement.tagName === 'LABEL') {
    parentElement = parentElement.parentNode;
  }
  
  if (!parentElement) {
    console.warn('Cannot show saved indicator: no suitable parent found');
    return;
  }
  
  removeSaveIndicators(field);
  const indicator = document.createElement('span');
  indicator.className = 'save-indicator saved';
  indicator.innerHTML = '‚úÖ Saved';
  indicator.style.cssText = 'margin-left: 8px; color: #4CAF50; font-size: 12px; display: inline-block;';
  
  // Insert after the field
  if (field.nextSibling) {
    parentElement.insertBefore(indicator, field.nextSibling);
  } else {
    parentElement.appendChild(indicator);
  }
  
  // Remove after 2 seconds
  setTimeout(() => {
    removeSaveIndicators(field);
  }, 2000);
}

function showErrorIndicator(field) {
  if (!field) {
    console.warn('Cannot show error indicator: field is null');
    return;
  }
  
  // Try to find a suitable parent element
  let parentElement = field.parentNode;
  if (!parentElement) {
    console.warn('Cannot show error indicator: field has no parentNode');
    return;
  }
  
  // If parent is a label, try to find the container
  if (parentElement.tagName === 'LABEL') {
    parentElement = parentElement.parentNode;
  }
  
  if (!parentElement) {
    console.warn('Cannot show error indicator: no suitable parent found');
    return;
  }
  
  removeSaveIndicators(field);
  const indicator = document.createElement('span');
  indicator.className = 'save-indicator error';
  indicator.innerHTML = '‚ùå Error';
  indicator.style.cssText = 'margin-left: 8px; color: #f44336; font-size: 12px; display: inline-block;';
  
  // Insert after the field
  if (field.nextSibling) {
    parentElement.insertBefore(indicator, field.nextSibling);
  } else {
    parentElement.appendChild(indicator);
  }
  
  // Remove after 3 seconds
  setTimeout(() => {
    removeSaveIndicators(field);
  }, 3000);
}

function removeSaveIndicators(field) {
  if (!field) {
    console.warn('Cannot remove save indicators: field is null');
    return;
  }
  
  try {
    // Look for indicators in the field's parent and grandparent
    let parentElement = field.parentNode;
    if (parentElement) {
      const indicators = parentElement.querySelectorAll('.save-indicator');
      indicators.forEach(indicator => {
        if (indicator && indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
        }
      });
      
      // Also check grandparent if parent is a label
      if (parentElement.tagName === 'LABEL' && parentElement.parentNode) {
        const grandParentIndicators = parentElement.parentNode.querySelectorAll('.save-indicator');
        grandParentIndicators.forEach(indicator => {
          if (indicator && indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
          }
        });
      }
    }
  } catch (error) {
    console.error('Error removing save indicators:', error);
  }
}

// Authentication-aware navigation
function isUserLoggedIn() {
  return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
}

function updateNavigation() {
  const authMenu = document.getElementById('auth-menu');
  const loginBtn = document.getElementById('login-btn');
  const loginDropdown = document.getElementById('login-dropdown');
  
  const mobileAuthMenu = document.getElementById('mobile-auth-menu');
  const mobileLoginBtn = document.getElementById('mobile-login-btn');
  const mobileLoginDropdown = document.getElementById('mobile-login-dropdown');

  if (isUserLoggedIn()) {
    // Desktop navigation
    if (authMenu && loginBtn) {
      authMenu.classList.remove('dropdown');
      loginBtn.textContent = 'myGREIA';
      loginBtn.href = '/pages/profile.html';
      if (loginDropdown) {
        loginDropdown.style.display = 'none';
      }
    }
    
    // Mobile navigation
    if (mobileAuthMenu && mobileLoginBtn) {
      mobileAuthMenu.classList.remove('dropdown');
      mobileLoginBtn.textContent = 'myGREIA';
      mobileLoginBtn.href = '/pages/profile.html';
      if (mobileLoginDropdown) {
        mobileLoginDropdown.style.display = 'none';
      }
    }
  } else {
    // Desktop navigation
    if (authMenu && loginBtn) {
      authMenu.classList.add('dropdown');
      loginBtn.textContent = 'Log In';
      loginBtn.href = '/pages/login.html';
      if (loginDropdown) {
        loginDropdown.style.display = '';
      }
    }
    
    // Mobile navigation
    if (mobileAuthMenu && mobileLoginBtn) {
      mobileAuthMenu.classList.add('dropdown');
      mobileLoginBtn.textContent = 'Log In';
      mobileLoginBtn.href = '/pages/login.html';
      if (mobileLoginDropdown) {
        mobileLoginDropdown.style.display = '';
      }
    }
  }
}

// Update navigation on page load
document.addEventListener('DOMContentLoaded', updateNavigation);

// Listen for storage changes (when user logs in/out on another page)
window.addEventListener('storage', function(e) {
  if (e.key === 'authToken') {
    updateNavigation();
  }
});

// Listen for custom events
window.addEventListener('userLoggedIn', updateNavigation);
window.addEventListener('userLoggedOut', updateNavigation);

// Close modals when clicking outside
window.addEventListener('click', function(event) {
  const editModal = document.getElementById('edit-profile-modal');
  if (event.target === editModal) {
    closeEditProfileModal();
  }
  
  const psraModal = document.getElementById('psra-verification-modal');
  if (event.target === psraModal) {
    closePSRAModal();
  }
});

// Edit Profile Modal Functions
function showEditProfileModal() {
  // Populate form with current user data
  if (currentUser) {
    document.getElementById('modal-edit-full_name').value = currentUser.full_name || '';
    document.getElementById('modal-edit-email').value = currentUser.email || '';
    document.getElementById('modal-edit-phone_number').value = currentUser.phone_number || '';
    document.getElementById('modal-edit-company').value = currentUser.company_name || currentUser.company || '';
    document.getElementById('modal-edit-profession').value = currentUser.profession || '';
    document.getElementById('modal-edit-bio').value = currentUser.bio || '';
    document.getElementById('modal-edit-receive_notifications').checked = !!currentUser.receive_notifications;
    document.getElementById('modal-edit-receive_sms').checked = !!currentUser.receive_sms;
    
    // Set current role
    const currentRole = currentUser.role || 'user';
    const roleRadio = document.getElementById(`role-${currentRole.replace('_', '-')}`);
    if (roleRadio) {
      roleRadio.checked = true;
      handleRoleChange(currentRole);
    }
  }
  
  document.getElementById('edit-profile-modal').style.display = 'block';
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeEditProfileModal() {
  document.getElementById('edit-profile-modal').style.display = 'none';
  document.body.style.overflow = 'auto'; // Restore scrolling
}

// PSRA License Verification Functions
async function verifyPSRALicense() {
  const licenseNumber = document.getElementById('license_number').value.trim();
  const statusDiv = document.getElementById('psra-verification-status');
  const modal = document.getElementById('psra-verification-modal');
  const content = document.getElementById('psra-verification-content');
  
  if (!licenseNumber) {
    statusDiv.innerHTML = '<div style="color: #dc2626; font-size: 14px; margin-top: 5px;">‚ö†Ô∏è Please enter a license number first</div>';
    return;
  }
  
  // Show loading in status area
  statusDiv.innerHTML = '<div style="color: #059669; font-size: 14px; margin-top: 5px;">üîç Verifying license...</div>';
  
  // Show loading state in modal
  content.innerHTML = `
    <div class="psra-verification-result psra-loading">
      <div style="display: flex; align-items: center; gap: 10px;">
        <div style="width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        Verifying license ${licenseNumber} with PSRA...
      </div>
    </div>
    <div style="margin-top: 15px;">
      <p><strong>License Number:</strong> ${licenseNumber}</p>
      <p><strong>Verification Method:</strong> PSRA Register Check</p>
      <p><strong>Website:</strong> <a href="https://www.psr.ie/website/npsra/psr.nsf/page/registers-search-en" target="_blank">PSRA Register Search</a></p>
    </div>
  `;
  
  modal.style.display = 'block';
  
  try {
    // Attempt automated verification first
    const response = await fetch('/api/verify-psra-license', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ licenseNumber })
    });
    
    const data = await response.json();
    
    if (data.success) {
      displayPSRAVerificationResult(licenseNumber, data.verification);
      updateStatusDisplay(data.verification.status, licenseNumber);
    } else {
      // Fallback to manual verification instructions
      displayManualPSRAVerification(licenseNumber);
      statusDiv.innerHTML = '<div style="color: #d97706; font-size: 14px; margin-top: 5px;">‚ö†Ô∏è Manual verification required - check modal</div>';
    }
  } catch (error) {
    console.error('PSRA verification error:', error);
    displayManualPSRAVerification(licenseNumber);
    statusDiv.innerHTML = '<div style="color: #d97706; font-size: 14px; margin-top: 5px;">‚ö†Ô∏è Manual verification required - check modal</div>';
  }
}

function updateStatusDisplay(status, licenseNumber) {
  const statusDiv = document.getElementById('psra-verification-status');
  
  if (status === 'valid') {
    statusDiv.innerHTML = '<div style="color: #16a34a; font-size: 14px; margin-top: 5px;">‚úÖ License verified with PSRA</div>';
  } else if (status === 'invalid') {
    statusDiv.innerHTML = '<div style="color: #dc2626; font-size: 14px; margin-top: 5px;">‚ùå License not found in PSRA register</div>';
  } else {
    statusDiv.innerHTML = '<div style="color: #d97706; font-size: 14px; margin-top: 5px;">‚ö†Ô∏è Verification completed - see results</div>';
  }
}

function displayPSRAVerificationResult(licenseNumber, verification) {
  const content = document.getElementById('psra-verification-content');
  
  const isValid = verification.status === 'valid';
  const resultClass = isValid ? 'psra-verified' : 'psra-not-found';
  const resultIcon = isValid ? '‚úÖ' : '‚ùå';
  
  content.innerHTML = `
    <div class="psra-verification-result ${resultClass}">
      <h4 style="margin-bottom: 10px;">${resultIcon} ${isValid ? 'License Verified' : 'License Not Found'}</h4>
      <p style="margin-bottom: 15px;">${isValid ? 'This license is registered with PSRA.' : 'This license number was not found in the PSRA register.'}</p>
    </div>
    
    <div style="margin-top: 20px;">
      <h5 style="margin-bottom: 10px;">Verification Details:</h5>
      <p><strong>License Number:</strong> ${licenseNumber}</p>
      <p><strong>Status:</strong> ${verification.status}</p>
      ${verification.holderName ? `<p><strong>License Holder:</strong> ${verification.holderName}</p>` : ''}
      ${verification.businessName ? `<p><strong>Business Name:</strong> ${verification.businessName}</p>` : ''}
      ${verification.licenseType ? `<p><strong>License Type:</strong> ${verification.licenseType}</p>` : ''}
      ${verification.issueDate ? `<p><strong>Issue Date:</strong> ${verification.issueDate}</p>` : ''}
      ${verification.expiryDate ? `<p><strong>Expiry Date:</strong> ${verification.expiryDate}</p>` : ''}
      <p><strong>Verified On:</strong> ${new Date().toLocaleDateString()}</p>
    </div>
    
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
      <p><strong>Source:</strong> Property Services Regulatory Authority (PSRA)</p>
      <p><strong>Website:</strong> <a href="https://www.psr.ie/website/npsra/psr.nsf/page/registers-search-en" target="_blank">https://www.psr.ie</a></p>
    </div>
  `;
}

function displayManualPSRAVerification(licenseNumber) {
  const content = document.getElementById('psra-verification-content');
  
  content.innerHTML = `
    <div class="psra-verification-result psra-error">
      <h4 style="margin-bottom: 10px;">‚ö†Ô∏è Manual Verification Required</h4>
      <p style="margin-bottom: 15px;">Automated verification is currently unavailable. Please verify manually using the PSRA website.</p>
    </div>
    
    <div style="margin-top: 20px;">
      <h5 style="margin-bottom: 10px;">Manual Verification Steps:</h5>
      <ol style="margin-left: 20px; line-height: 1.8;">
        <li>Visit the <a href="https://www.psr.ie/website/npsra/psr.nsf/page/registers-search-en" target="_blank" style="color: #3b82f6;">PSRA Register Search</a></li>
        <li>Search for license number: <strong>${licenseNumber}</strong></li>
        <li>Verify the license holder details match your information</li>
        <li>Check the license status and expiry date</li>
        <li>If verified, you can proceed with your application</li>
      </ol>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
      <h6 style="margin-bottom: 10px;">üîó Quick Links:</h6>
      <ul style="margin-left: 20px; line-height: 1.6;">
        <li><a href="https://www.psr.ie/website/npsra/psr.nsf/page/registers-search-en" target="_blank">PSRA Register Search</a></li>
        <li><a href="https://www.psr.ie/website/npsra/psr.nsf/page/property-services-providers-register-en" target="_blank">Property Services Providers Register</a></li>
        <li><a href="https://www.psr.ie/website/npsra/psr.nsf/page/auctioneers-register-en" target="_blank">Auctioneers Register</a></li>
      </ul>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #fff5f5; border-radius: 8px; border: 1px solid #fed7d7;">
      <h6 style="color: #e53e3e; margin-bottom: 10px;">üìã Important Note:</h6>
      <p style="color: #2d3748; line-height: 1.6; margin-bottom: 0;">Your property agent verification will still be processed by our admin team. Please ensure your license number is correct and that you have uploaded all required documentation.</p>
    </div>
  `;
}

function closePSRAModal() {
  document.getElementById('psra-verification-modal').style.display = 'none';
}

function handleRoleChange(role) {
  const docsSection = document.getElementById('property-agent-docs');
  const roleLabels = document.querySelectorAll('label[onclick^="handleRoleChange"]');
  
  // Reset all role label styles
  roleLabels.forEach(label => {
    label.style.borderColor = '#e5e7eb';
    label.style.background = 'white';
  });
  
  // Highlight selected role
  const selectedLabel = document.querySelector(`label[onclick="handleRoleChange('${role}')"]`);
  if (selectedLabel) {
    selectedLabel.style.borderColor = '#1c0bff';
    selectedLabel.style.background = 'rgba(28,11,255,0.05)';
  }
  
  // Show/hide documentation section based on role
  if (role === 'property_agent') {
    docsSection.style.display = 'block';
  } else {
    docsSection.style.display = 'none';
  }
}

// Handle enhanced profile form submission
document.addEventListener('DOMContentLoaded', function() {
  const enhancedForm = document.getElementById('enhanced-edit-profile-form');
  if (enhancedForm) {
    enhancedForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      
      // Add verification status for property agents
      const selectedRole = formData.get('role');
      if (selectedRole === 'property_agent') {
        formData.append('verification_status', 'pending');
        formData.append('verification_submitted_at', new Date().toISOString());
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + (localStorage.getItem('token') || sessionStorage.getItem('token'))
          },
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Server responded with ${response.status}`);
        }
        
        const data = await response.json();
        
        // Show success message based on role
        if (selectedRole === 'property_agent') {
          alert('Profile updated successfully! Your property agent verification documents have been submitted for review. You will be notified once the verification process is complete.');
        } else {
          alert('Profile updated successfully!');
        }
        
        // Update current user data
        currentUser = { ...currentUser, ...data };
        
        // Refresh profile display
        updateProfileDisplay(currentUser);
        
        // Close modal
        closeEditProfileModal();
        
        // Refresh the page to show any role-specific features
        if (selectedRole !== (currentUser.role || 'user')) {
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
        
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error updating profile: ' + error.message);
      }
    });
  }
});

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('edit-profile-modal');
  if (e.target === modal) {
    closeEditProfileModal();
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeEditProfileModal();
  }
});

</script>
<script src="../js/profile-loader.js"></script>
<div data-include="/components/footer.html"></div>
<script src="/public/js/greia-auto-mount.js"></script>
<script src="/scripts/includes.js"></script>
</body>
<div class="profile-section" id="section-exposure-packages">
  <h2>Exposure Packages</h2>
  <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px;">
    üöÄ <strong>Boost your listing visibility!</strong> Select an exposure package below to feature your property or advertisement more prominently on D4Rent.ie.
  </div>
  <form id="exposure-package-form">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
      <label style="background:#fff; border:2px solid #a259d9; border-radius:10px; min-width:220px; min-height:220px; height:220px; display:flex; flex-direction:column; justify-content:center; align-items:flex-start; padding:24px; cursor:pointer; position:relative;">
        <input type="radio" name="package_type" value="platinum" style="position:absolute;top:16px;right:16px;transform:scale(1.3);" required>
        <div style="display:flex;align-items:center;margin-bottom:8px;">
          <span style="width:32px;height:32px;display:inline-block;background:linear-gradient(135deg,#a259d9 60%,#c7b299 100%);border-radius:50%;margin-right:10px;"></span>
          <span style="font-weight:700;color:#a259d9;font-size:1.1em;">Platinum</span>
        </div>
        <div style="font-size:1.3em;font-weight:800;color:#a259d9;">‚Ç¨299.99</div>
        <div style="margin-bottom:8px;">Subscriptions</div>
        <div style="font-size:0.98em;color:#555;">Created: 18 Jul</div>
      </label>
      <label style="background:#fff; border:2px solid #ffd700; border-radius:10px; min-width:220px; min-height:220px; height:220px; display:flex; flex-direction:column; justify-content:center; align-items:flex-start; padding:24px; cursor:pointer; position:relative;">
        <input type="radio" name="package_type" value="gold" style="position:absolute;top:16px;right:16px;transform:scale(1.3);">
        <div style="display:flex;align-items:center;margin-bottom:8px;">
          <span style="width:32px;height:32px;display:inline-block;background:linear-gradient(135deg,#ffd700 80%,#fffbe6 100%);border-radius:50%;margin-right:10px;"></span>
          <span style="font-weight:700;color:#ffd700;font-size:1.1em;">Gold</span>
        </div>
        <div style="font-size:1.3em;font-weight:800;color:#ffd700;">‚Ç¨149.99</div>
        <div style="margin-bottom:8px;">Subscriptions</div>
        <div style="font-size:0.98em;color:#555;">Created: 18 Jul</div>
      </label>
      <label style="background:#fff; border:2px solid #c0c0c0; border-radius:10px; min-width:220px; min-height:220px; height:220px; display:flex; flex-direction:column; justify-content:center; align-items:flex-start; padding:24px; cursor:pointer; position:relative;">
        <input type="radio" name="package_type" value="silver" style="position:absolute;top:16px;right:16px;transform:scale(1.3);">
        <div style="display:flex;align-items:center;margin-bottom:8px;">
          <span style="width:32px;height:32px;display:inline-block;background:linear-gradient(135deg,#c0c0c0 80%,#f5f5f5 100%);border-radius:50%;margin-right:10px;"></span>
          <span style="font-weight:700;color:#c0c0c0;font-size:1.1em;">Silver</span>
        </div>
        <div style="font-size:1.3em;font-weight:800;color:#c0c0c0;">‚Ç¨99.99</div>
        <div style="margin-bottom:8px;">Subscriptions</div>
        <div style="font-size:0.98em;color:#555;">Created: 18 Jul</div>
      </label>
    </div>
    <div style="display: flex; gap: 12px; margin-top: 16px;">
      <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block;">Purchase Exposure Package</button>
    </div>
  </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const exposureForm = document.getElementById('exposure-package-form');
  if (exposureForm) {
    exposureForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(exposureForm);
      const packageType = formData.get('package_type');
      const duration = formData.get('duration');
      const listingId = formData.get('listing_id');
      // Step 1: Save exposure package request (optional, if backend requires)
      let exposureRes;
      try {
        exposureRes = await fetch('/api/exposure', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
      } catch (err) {
        alert('Failed to save exposure package request.');
        return;
      }
      if (!exposureRes.ok) {
        alert('Failed to save exposure package request.');
        return;
      }
      const exposureData = await exposureRes.json();
      // Step 2: Request Stripe Checkout session
      let stripeRes;
      try {
        stripeRes = await fetch('/api/payments/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ productType: 'exposure', option: packageType, duration, listingId, exposureId: exposureData.id })
        });
      } catch (err) {
        alert('Failed to start payment.');
        return;
      }
      if (!stripeRes.ok) {
        alert('Failed to start payment.');
        return;
      }
      const stripeData = await stripeRes.json();
      if (stripeData.url) {
        window.location.href = stripeData.url;
      } else {
        alert('Payment link not received.');
      }
    });
  }
});
</script>

  <!-- Edit Profile Modal -->
  <div id="edit-profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
    <div style="background: white; margin: 50px auto; max-width: 800px; border-radius: 16px; position: relative; max-height: 90vh; overflow-y: auto;">
      <div style="padding: 32px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: #222; font-size: 24px; font-weight: 700;">Edit Profile</h2>
        <button onclick="closeEditProfileModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 8px;">√ó</button>
      </div>
      
      <div style="padding: 32px;">
        <form id="enhanced-edit-profile-form" enctype="multipart/form-data">
          <!-- Basic Information -->
          <div style="margin-bottom: 32px;">
            <h3 style="color: #1c0bff; margin-bottom: 16px; font-size: 18px; font-weight: 600;">Basic Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Full Name</span>
                <input id="modal-edit-full_name" name="full_name" type="text" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" required/>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Email</span>
                <input id="modal-edit-email" name="email" type="email" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" required/>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Phone Number</span>
                <input id="modal-edit-phone_number" name="phone_number" type="tel" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Company Name</span>
                <input id="modal-edit-company" name="company" type="text" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
              </label>
            </div>
          </div>

          <!-- Role Selection -->
          <div style="margin-bottom: 32px;">
            <h3 style="color: #1c0bff; margin-bottom: 16px; font-size: 18px; font-weight: 600;">Account Type</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onclick="handleRoleChange('user')">
                <input type="radio" name="role" value="user" id="role-user" style="transform: scale(1.2);">
                <div>
                  <div style="font-weight: 600; color: #333;">Regular User</div>
                  <div style="font-size: 12px; color: #666;">Browse and save properties</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onclick="handleRoleChange('service_agent')">
                <input type="radio" name="role" value="service_agent" id="role-service-agent" style="transform: scale(1.2);">
                <div>
                  <div style="font-weight: 600; color: #333;">Service Agent</div>
                  <div style="font-size: 12px; color: #666;">Offer professional services</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onclick="handleRoleChange('property_agent')">
                <input type="radio" name="role" value="property_agent" id="role-property-agent" style="transform: scale(1.2);">
                <div>
                  <div style="font-weight: 600; color: #333;">Property Agent</div>
                  <div style="font-size: 12px; color: #666;">Licensed real estate professional</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Property Agent Documentation Section -->
          <div id="property-agent-docs" style="display: none; margin-bottom: 32px;">
            <h3 style="color: #ff6b35; margin-bottom: 16px; font-size: 18px; font-weight: 600;">
              <i class="fas fa-certificate" style="margin-right: 8px;"></i>Property Agent Verification
            </h3>
            <div style="background: #fff5f5; border: 2px solid #fed7d7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h4 style="color: #e53e3e; margin-bottom: 12px; font-size: 16px;">üìã Required Documentation</h4>
              <p style="color: #2d3748; margin-bottom: 16px; line-height: 1.6;">To verify your status as a licensed real estate agent, please upload the following documents. All documents will be reviewed by our admin team.</p>
              <ul style="color: #4a5568; line-height: 1.8; margin-left: 20px;">
                <li>Real estate license or certification</li>
                <li>Professional liability insurance certificate</li>
                <li>Government-issued ID or passport</li>
                <li>Business registration documents (if applicable)</li>
              </ul>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Real Estate License</span>
                <input type="file" name="license_document" accept=".pdf,.jpg,.jpeg,.png" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
                <span style="font-size: 12px; color: #666;">PDF, JPG, PNG accepted</span>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Insurance Certificate</span>
                <input type="file" name="insurance_document" accept=".pdf,.jpg,.jpeg,.png" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
                <span style="font-size: 12px; color: #666;">PDF, JPG, PNG accepted</span>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Government ID</span>
                <input type="file" name="id_document" accept=".pdf,.jpg,.jpeg,.png" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
                <span style="font-size: 12px; color: #666;">PDF, JPG, PNG accepted</span>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Business Registration (Optional)</span>
                <input type="file" name="business_document" accept=".pdf,.jpg,.jpeg,.png" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
                <span style="font-size: 12px; color: #666;">PDF, JPG, PNG accepted</span>
              </label>
            </div>
            
            <div style="margin-top: 16px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">License Number</span>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="text" name="license_number" id="license_number" placeholder="Enter your real estate license number" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; flex: 1;"/>
                  <button type="button" id="verify-psra-btn" onclick="verifyPSRALicense()" style="background: #059669; color: white; padding: 12px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; transition: background-color 0.2s;">
                    üîç Verify PSRA
                  </button>
                </div>
                <div id="psra-verification-status" style="margin-top: 8px;"></div>
              </label>
            </div>
            
            <div style="margin-top: 16px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Additional Notes</span>
                <textarea name="agent_notes" rows="3" placeholder="Any additional information about your qualifications or experience..." style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
              </label>
            </div>
          </div>

          <!-- Professional Details -->
          <div style="margin-bottom: 32px;">
            <h3 style="color: #1c0bff; margin-bottom: 16px; font-size: 18px; font-weight: 600;">Professional Details</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Profession</span>
                <input id="modal-edit-profession" name="profession" type="text" placeholder="e.g. Real Estate Agent, Architect, Plumber" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                <span style="font-weight: 600; color: #333;">Profile Picture</span>
                <input name="profile_picture" type="file" accept="image/*" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"/>
              </label>
            </div>
            <label style="display: flex; flex-direction: column; gap: 6px;">
              <span style="font-weight: 600; color: #333;">Bio</span>
              <textarea id="modal-edit-bio" name="bio" rows="4" placeholder="Tell us about yourself and your professional background..." style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
            </label>
          </div>

          <!-- Notification Preferences -->
          <div style="margin-bottom: 32px;">
            <h3 style="color: #1c0bff; margin-bottom: 16px; font-size: 18px; font-weight: 600;">Notification Preferences</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 12px;">
                <input id="modal-edit-receive_notifications" name="receive_notifications" type="checkbox" style="transform: scale(1.2);"/>
                <span style="color: #333;">Receive Email Notifications</span>
              </label>
              <label style="display: flex; align-items: center; gap: 12px;">
                <input id="modal-edit-receive_sms" name="receive_sms" type="checkbox" style="transform: scale(1.2);"/>
                <span style="color: #333;">Receive SMS Notifications</span>
              </label>
            </div>
          </div>

          <!-- Form Actions -->
          <div style="display: flex; gap: 16px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 24px;">
            <button type="button" onclick="closeEditProfileModal()" style="background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
            <button type="submit" style="background: #1c0bff; color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px rgba(28,11,255,0.2);">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- PSRA Verification Modal -->
  <div id="psra-verification-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2001; overflow-y: auto;">
    <div style="background: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
        <h3 style="margin: 0; color: #1e293b; font-size: 20px;">PSRA License Verification</h3>
        <button onclick="closePSRAModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; line-height: 1;">&times;</button>
      </div>
      <div id="psra-verification-content">
        <!-- PSRA verification results will be populated here -->
      </div>
    </div>
  </div>

  <!-- Footer -->
  

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</html>